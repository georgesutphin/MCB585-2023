















<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="last-modified" content="2024-08-15 20:50:19 -0700">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- meta "search-domain" used for google site search function google_search() -->
    <meta name="search-domain" value="">
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/lesson.css" />
    <link rel="stylesheet" type="text/css" href="../assets/css/syntax.css" />

    



    <!-- Favicons for everyone -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="../assets/favicons/mcb585/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/favicons/mcb585/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/favicons/mcb585/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/favicons/mcb585/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="../assets/favicons/mcb585/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="../assets/favicons/mcb585/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="../assets/favicons/mcb585/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../assets/favicons/mcb585/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="../assets/favicons/mcb585/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="../assets/favicons/mcb585/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="../assets/favicons/mcb585/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="../assets/favicons/mcb585/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="../assets/favicons/mcb585/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content=" - MCB 585: Multidisciplinary/Quantitative Approaches to Solving Biological Problems"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="../assets/favicons/mcb585/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="../assets/favicons/mcb585/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="../assets/favicons/mcb585/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="../assets/favicons/mcb585/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="../assets/favicons/mcb585/mstile-310x310.png" />


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
    <title>MCB 585: Multidisciplinary/Quantitative Approaches to Solving Biological Problems: Advanced Survival Analysis</title>
  </head>
  <body>

    



    <div class="container">
      






<nav class="navbar navbar-default">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      
      
      <a href="https://georgesutphin.github.io/MCB585/" class="pull-left">
        <img class="navbar-logo" src="../assets/img/mcb585-logo.svg" alt="MCB585 logo" />
      </a>
      

      
      <a class="navbar-brand" href="../">Home</a>

    </div>
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">

	
        <li><a href="../CODE_OF_CONDUCT.html">Code of Conduct</a></li>

        
	
        <li><a href="../setup.html">Setup</a></li>

        
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Episodes <span class="caret"></span></a>
          <ul class="dropdown-menu">
            
            <li><a href="../01-class-introduction/index.html">Getting started with R and RStudio</a></li>
            
            <li><a href="../01-oyo-introduction/index.html">Getting started with R and RStudio -- Additional Detail</a></li>
            
            <li><a href="../02-class-R-data-types-structures/index.html">Basic Data Types and Data Structures in R</a></li>
            
            <li><a href="../02-oyo-R-data-types-in-depth/index.html">R Data Types -- In-Depth</a></li>
            
            <li><a href="../03-class-data-frames/index.html">Data Frames, Basic Indexing, Reading/Writing Data</a></li>
            
            <li><a href="../03-oyo-Lists/index.html">Lists and Advanced Indexing</a></li>
            
            <li><a href="../04-class-manipulating-plotting-data/index.html">Manipulating and Plotting Data</a></li>
            
            <li><a href="../04-oyo-advanced-data-manipulation/index.html">Advanced Data Manipulation and Plotting</a></li>
            
            <li><a href="../05-class-decisions-loops/index.html">Decision Making and Loops</a></li>
            
            <li><a href="../05-oyo-more-decisions-loops/index.html">Decision Making and Loops -- Additional Detail</a></li>
            
            <li><a href="../06-class-distributions/index.html">Distributions and Normality</a></li>
            
            <li><a href="../06-oyo-more-distributions/index.html">Distributions and Normality -- Additional Detail</a></li>
            
            <li><a href="../07-class-hypothesis-testing/index.html">Hypothesis Testing</a></li>
            
            <li><a href="../07-oyo-multiple-test-correction/index.html">Multiple Test Correction</a></li>
            
            <li><a href="../08-class-survival-analysis/index.html">Survival Analysis</a></li>
            
            <li><a href="../08-oyo-advanced-survival-analysis/index.html">Advanced Survival Analysis</a></li>
            
            <li><a href="../09-class-power-analysis/index.html">Power Analysis</a></li>
            
            <li><a href="../09-oyo-simulation/index.html">Simulating Experiments</a></li>
            
            <li><a href="../99-projects/index.html">Final Projects</a></li>
            
	    <li role="separator" class="divider"></li>
            <li><a href="../aio.html">All in one page (Beta)</a></li>
          </ul>
        </li>
	

	
	<!--
        <li class="dropdown">
          <a href="../" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Extras <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../reference.html">Reference</a></li>
            
            <li><a href="../about/">About</a></li>
            
            <li><a href="../discuss/">Discussion</a></li>
            
            <li><a href="../figures/">Figures</a></li>
            
            <li><a href="../guide/">Instructor Notes</a></li>
            
          </ul>
        </li>
	-->

	
        <li><a href="../LICENSE.html">About</a></li>
	<!--
	
	<li><a href="/edit//_episodes_rmd/08-oyo-advanced-survival-analysis.Rmd">Improve this page <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a></li>
	
	-->
      </ul>
      <form class="navbar-form navbar-right" role="search" id="search" onsubmit="google_search(); return false;">
        <div class="form-group">
          <input type="text" id="google-search" placeholder="Search..." aria-label="Google site search">
        </div>
      </form>
    </div>
  </div>
</nav>

















<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../08-class-survival-analysis/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
    <h3 class="maintitle"><a href="../">MCB 585: Multidisciplinary/Quantitative Approaches to Solving Biological Problems</a></h3>
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../09-class-power-analysis/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>

<article>
<div class="row">
  <div class="col-md-1">
  </div>
  <div class="col-md-10">
    <h1 class="maintitle">Advanced Survival Analysis</h1>
  </div>
  <div class="col-md-1">
  </div>
</div>


<blockquote class="objectives">
  <h2>Overview</h2>

  <div class="row">
    <div class="col-md-3">
      <strong>Class Date:</strong> 9/19/2023 -- On Your Own
      <br/>
      <strong>Teaching:</strong> 90 min
      <br/>
      <strong>Exercises:</strong> 30 min
    </div>
    <div class="col-md-9">
      <strong>Questions</strong>
      <ul>
	
	<li><p>How do you extract life table information from <code class="language-plaintext highlighter-rouge">survfit()</code> objects in R?</p>
</li>
	
	<li><p>How do you plot age-specific mortality (aka the hazard function) when a life table is not provided?</p>
</li>
	
      </ul>
    </div>
  </div>

  <div class="row">
    <div class="col-md-3">
    </div>
    <div class="col-md-9">
      <strong>Objectives</strong>
      <ul>
	
	<li><p>Understand the process for extracting life table information from the object created by the <code class="language-plaintext highlighter-rouge">survfit()</code> function.</p>
</li>
	
	<li><p>Use this information to plot age-specific mortality.</p>
</li>
	
	<li><p>Practice using <code class="language-plaintext highlighter-rouge">Surv()</code>, <code class="language-plaintext highlighter-rouge">survfit()</code>, and <code class="language-plaintext highlighter-rouge">survdiff()</code> on available data.</p>
</li>
	
      </ul>
    </div>
  </div>

</blockquote>

<h2 id="on-your-own">On Your Own</h2>

<p>Working with survival data in R is not straightforward and practice is useful for getting the hang of using the <code class="language-plaintext highlighter-rouge">Surv()</code> object and the functions for generating survival curves and running log-rank tests. For the most part, today’s <em>On Your Own</em> material consists of additional exercise, with one practical note for dealing with an odd data structure.</p>

<hr />
<h3 id="extracting-life-table-data-from-survfit">Extracting life table data from <code class="language-plaintext highlighter-rouge">survfit()</code></h3>

<p><em>In Class</em> we looked at a life table for human mortality in the US. We were able to examine the age-specific \(\mu_x\)  (aka the hazard function \(\lambda(t)\), which is one useful way to evaluate differences between groups in survival data. Because the log of age-specific mortality increases linearly with age, the intercept of this line can be interpreted as “initial mortality” in a population, and the slope as “rate of aging” (aka the rate at which the chance of dying at a given time increases with age).</p>

<p>If we want to examine age-specific mortality for a survival dataset where the life table is not pre-built for us, R does not provide a straightforward solution. There is no function in R to directly plot \(\mu_x\), so we have 
to extract the life tables and calculate it manually. Let’s revisity the lifespan data for the BUB/BnJ mouse strain that we looked at <em>In Class</em>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load the survival package</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"survival"</span><span class="p">)</span><span class="w">

</span><span class="c1"># read in inbred strain lifespan data and subset ou thet BUB/BnJ strain</span><span class="w">
</span><span class="n">data.surv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.delim</span><span class="p">(</span><span class="s2">"data/inbred.lifespan.txt"</span><span class="p">)</span><span class="w">
</span><span class="n">surv.bub</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.surv</span><span class="p">[</span><span class="n">data.surv</span><span class="o">$</span><span class="n">strain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"BUB/BnJ"</span><span class="p">,]</span><span class="w">

</span><span class="c1"># calculate life table for BUB/BnJ mice with sex as an independent variable</span><span class="w">
</span><span class="n">survfit.bub.sex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survfit</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan_days</span><span class="p">,</span><span class="w"> </span><span class="n">censor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">sex</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">surv.bub</span><span class="p">)</span><span class="w">

</span><span class="c1"># use summary() to capture the life table in a new variable</span><span class="w">
</span><span class="n">summary.bub</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">summary</span><span class="p">(</span><span class="n">survfit.bub.sex</span><span class="p">)</span><span class="w">
</span><span class="n">summary.bub</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Call: survfit(formula = Surv(lifespan_days, censor == 0) ~ sex, data = surv.bub)

                sex=f 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
  266     24       1   0.9583  0.0408      0.88163        1.000
  279     23       1   0.9167  0.0564      0.81250        1.000
  328     22       1   0.8750  0.0675      0.75221        1.000
  343     21       1   0.8333  0.0761      0.69681        0.997
  357     20       1   0.7917  0.0829      0.64478        0.972
  455     19       1   0.7500  0.0884      0.59531        0.945
  457     18       1   0.7083  0.0928      0.54795        0.916
  495     17       1   0.6667  0.0962      0.50240        0.885
  523     16       1   0.6250  0.0988      0.45845        0.852
  538     15       1   0.5833  0.1006      0.41598        0.818
  551     14       1   0.5417  0.1017      0.37489        0.783
  621     13       1   0.5000  0.1021      0.33513        0.746
  628     12       1   0.4583  0.1017      0.29668        0.708
  635     11       1   0.4167  0.1006      0.25954        0.669
  670     10       1   0.3750  0.0988      0.22373        0.629
  678      9       1   0.3333  0.0962      0.18930        0.587
  722      8       1   0.2917  0.0928      0.15636        0.544
  726      7       1   0.2500  0.0884      0.12502        0.500
  810      6       1   0.2083  0.0829      0.09551        0.454
  818      5       1   0.1667  0.0761      0.06813        0.408
  867      4       1   0.1250  0.0675      0.04337        0.360
  904      3       1   0.0833  0.0564      0.02211        0.314
  965      2       1   0.0417  0.0408      0.00612        0.284
 1034      1       1   0.0000     NaN           NA           NA

                sex=m 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
  260     28       1   0.9643  0.0351      0.89794        1.000
  287     24       1   0.9241  0.0517      0.82807        1.000
  301     23       1   0.8839  0.0632      0.76836        1.000
  307     22       1   0.8438  0.0720      0.71386        0.997
  341     21       1   0.8036  0.0790      0.66280        0.974
  354     20       2   0.7232  0.0892      0.56792        0.921
  366     18       1   0.6830  0.0929      0.52328        0.892
  383     16       1   0.6403  0.0964      0.47678        0.860
  426     15       1   0.5977  0.0989      0.43205        0.827
  447     14       1   0.5550  0.1007      0.38893        0.792
  493     13       1   0.5123  0.1016      0.34732        0.756
  608     12       1   0.4696  0.1017      0.30718        0.718
  693     11       2   0.3842  0.0995      0.23125        0.638
  768      9       1   0.3415  0.0972      0.19552        0.597
  855      8       1   0.2988  0.0939      0.16137        0.553
  873      7       1   0.2561  0.0897      0.12894        0.509
  874      6       1   0.2134  0.0843      0.09843        0.463
  875      5       1   0.1708  0.0775      0.07016        0.416
  888      4       1   0.1281  0.0689      0.04463        0.368
  889      3       2   0.0427  0.0417      0.00628        0.290
 1020      1       1   0.0000     NaN           NA           NA
</code></pre></div></div>

<p> </p>

<p>Let’s take a closer look at the structure of the life tables stored in the <code class="language-plaintext highlighter-rouge">summary.bub</code> object:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">str</span><span class="p">(</span><span class="n">summary.bub</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>List of 19
 $ n            : int [1:2] 32 32
 $ time         : num [1:45] 266 279 328 343 357 455 457 495 523 538 ...
 $ n.risk       : num [1:45] 24 23 22 21 20 19 18 17 16 15 ...
 $ n.event      : num [1:45] 1 1 1 1 1 1 1 1 1 1 ...
 $ n.censor     : num [1:45] 8 0 0 0 0 0 0 0 0 0 ...
 $ surv         : num [1:45] 0.958 0.917 0.875 0.833 0.792 ...
 $ std.err      : num [1:45] 0.0408 0.0564 0.0675 0.0761 0.0829 ...
 $ cumhaz       : num [1:45] 0.0417 0.0851 0.1306 0.1782 0.2282 ...
 $ std.chaz     : num [1:45] 0.0417 0.0602 0.0754 0.0892 0.1023 ...
 $ strata       : Factor w/ 2 levels "sex=f","sex=m": 1 1 1 1 1 1 1 1 1 1 ...
 $ type         : chr "right"
 $ logse        : logi TRUE
 $ conf.int     : num 0.95
 $ conf.type    : chr "log"
 $ lower        : num [1:45] 0.882 0.813 0.752 0.697 0.645 ...
 $ upper        : num [1:45] 1 1 1 0.997 0.972 ...
 $ call         : language survfit(formula = Surv(lifespan_days, censor == 0) ~ sex, data = surv.bub)
 $ table        : num [1:2, 1:9] 32 32 32 32 32 ...
  ..- attr(*, "dimnames")=List of 2
  .. ..$ : chr [1:2] "sex=f" "sex=m"
  .. ..$ : chr [1:9] "records" "n.max" "n.start" "events" ...
 $ rmean.endtime: num [1:2] 1034 1034
 - attr(*, "class")= chr "summary.survfit"
</code></pre></div></div>

<p> </p>

<p>This object has a variable called <code class="language-plaintext highlighter-rouge">strata</code> that defines the groups by which the comparison is broken down, and thus the defining feature for the two separate life tables stored within the object. You can use this to extract the separate life table columns for each sex from <code class="language-plaintext highlighter-rouge">summary.bub</code>. Here we will just extract the specific columns that we need to calculate \(\mu_x\):</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># extract age, number of deaths, and number at risk at each age from the</span><span class="w">
</span><span class="c1"># life tables stored in `summary.bub`. Note that the names assigned to the </span><span class="w">
</span><span class="c1"># "strata" are in the form "&lt;variable&gt;=&lt;value&gt;", so we use "sex=f" to extract</span><span class="w">
</span><span class="c1"># the information for female mice</span><span class="w">
</span><span class="n">age.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">summary.bub</span><span class="o">$</span><span class="n">time</span><span class="p">[</span><span class="n">summary.bub</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"sex=f"</span><span class="p">]</span><span class="w">
</span><span class="n">n.event.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">summary.bub</span><span class="o">$</span><span class="n">n.event</span><span class="p">[</span><span class="n">summary.bub</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"sex=f"</span><span class="p">]</span><span class="w">
</span><span class="n">n.risk.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">summary.bub</span><span class="o">$</span><span class="n">n.risk</span><span class="p">[</span><span class="n">summary.bub</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"sex=f"</span><span class="p">]</span><span class="w">

</span><span class="c1"># calculate qt; note that this is an alternative way to get qx from using the </span><span class="w">
</span><span class="c1"># lx and lx+1 values. If you rearrange the life table equations you can derive </span><span class="w">
</span><span class="c1"># this form.</span><span class="w">
</span><span class="n">qx.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">n.event.f</span><span class="o">/</span><span class="n">n.risk.f</span><span class="w">

</span><span class="c1"># now calculate px and mux (mu is age-specific mortality)</span><span class="w">
</span><span class="n">px.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">qx.f</span><span class="w">
</span><span class="n">mux.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="nf">log</span><span class="p">(</span><span class="n">px.f</span><span class="p">)</span><span class="w">

</span><span class="c1"># for the male mice ("sex=m"), I am just going to combine the above few steps</span><span class="w">
</span><span class="c1"># into a single step.</span><span class="w">
</span><span class="n">age.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">summary.bub</span><span class="o">$</span><span class="n">time</span><span class="p">[</span><span class="n">summary.bub</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"sex=m"</span><span class="p">]</span><span class="w">
</span><span class="n">mux.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="nf">log</span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">summary.bub</span><span class="o">$</span><span class="n">n.event</span><span class="p">[</span><span class="n">summary.bub</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"sex=m"</span><span class="p">]</span><span class="o">/</span><span class="n">summary.bub</span><span class="o">$</span><span class="n">n.risk</span><span class="p">[</span><span class="n">summary.bub</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"sex=m"</span><span class="p">])</span><span class="w">

</span><span class="c1"># Now we can finally plot. Someone should write a function to do this...</span><span class="w">
</span><span class="c1"># Remember to put the y-axis on a log scale.</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">age.f</span><span class="p">,</span><span class="n">mux.f</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"y"</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"o"</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.7</span><span class="p">,</span><span class="w">  
     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Age"</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Age-Specific Mortality"</span><span class="p">,</span><span class="w">
     </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">summary.bub</span><span class="o">$</span><span class="n">time</span><span class="p">),</span><span class="nf">max</span><span class="p">(</span><span class="n">summary.bub</span><span class="o">$</span><span class="n">time</span><span class="p">)))</span><span class="w">
</span><span class="n">lines</span><span class="p">(</span><span class="n">age.m</span><span class="p">,</span><span class="n">mux.m</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"o"</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.7</span><span class="p">)</span><span class="w">
</span><span class="n">legend</span><span class="p">(</span><span class="s2">"bottomright"</span><span class="p">,</span><span class="n">legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"female"</span><span class="p">,</span><span class="s2">"male"</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"red"</span><span class="p">,</span><span class="s2">"blue"</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p><img src="../fig/rmd-08-oyo-advanced-survival-analysis-unnamed-chunk-4-1.png" title="plot of chunk unnamed-chunk-4" alt="plot of chunk unnamed-chunk-4" width="612" style="display: block; margin: auto;" /></p>

<p> </p>

<p>Note that these plots can be somewhat sensitive to time periods during the lifespan where few mice died (particularly the early portion), creating odd jumps and jogs like the one present near the early male lifespan. Pay attention to the general trends (slope, intercept) to get a feel for how the groups differ. In this case, It looks like the male and female BUB/BnJ mice are pretty similar, showing a similar intercept and slope for the log-mortality curves.</p>

<hr />
<h3 id="exercises">Exercises</h3>

<blockquote class="challenge">
  <h2 id="differences-in-male-vs-female-survival-and-mortality-in-modern-us-humans">Differences in male vs. female survival and mortality in modern US humans</h2>

  <p>Earlier we looked at survival and mortality in the US population. Now let’s
see how these differ by sex. Plot male and female survival and age-specific 
mortality  on the same plot for comparison. The life tables are stored in 
<code class="language-plaintext highlighter-rouge">US2011.life.table.male.txt</code> and <code class="language-plaintext highlighter-rouge">US2011.life.table.female.txt</code>, respectively.</p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load data</span><span class="w">
</span><span class="n">lt.male</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.delim</span><span class="p">(</span><span class="s2">"./data/US2011.life.table.male.txt"</span><span class="p">)</span><span class="w">
</span><span class="n">lt.female</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.delim</span><span class="p">(</span><span class="s2">"./data/US2011.life.table.female.txt"</span><span class="p">)</span><span class="w">

</span><span class="c1"># change names to our convention</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">lt.male</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"t"</span><span class="p">,</span><span class="s2">"qt"</span><span class="p">,</span><span class="s2">"nt"</span><span class="p">,</span><span class="s2">"dt"</span><span class="p">,</span><span class="s2">"Lt"</span><span class="p">,</span><span class="s2">"Tt"</span><span class="p">,</span><span class="s2">"et"</span><span class="p">)</span><span class="w">

</span><span class="c1"># calculate lt, pt, and lambdat</span><span class="w">
</span><span class="n">lt.male</span><span class="o">$</span><span class="n">lt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lt.male</span><span class="o">$</span><span class="n">nt</span><span class="o">/</span><span class="nf">max</span><span class="p">(</span><span class="n">lt.male</span><span class="o">$</span><span class="n">nt</span><span class="p">)</span><span class="w">
</span><span class="n">lt.male</span><span class="o">$</span><span class="n">pt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lt.male</span><span class="o">$</span><span class="n">qt</span><span class="w">
</span><span class="n">lt.male</span><span class="o">$</span><span class="n">lambdat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="nf">log</span><span class="p">(</span><span class="n">lt.male</span><span class="o">$</span><span class="n">pt</span><span class="p">)</span><span class="w">

</span><span class="c1"># change names to our convention (lx -&gt; nx)</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">lt.female</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"t"</span><span class="p">,</span><span class="s2">"qt"</span><span class="p">,</span><span class="s2">"nt"</span><span class="p">,</span><span class="s2">"dt"</span><span class="p">,</span><span class="s2">"Lt"</span><span class="p">,</span><span class="s2">"Tt"</span><span class="p">,</span><span class="s2">"et"</span><span class="p">)</span><span class="w">

</span><span class="c1"># calculate lt, pt, and lambdat</span><span class="w">
</span><span class="n">lt.female</span><span class="o">$</span><span class="n">lt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lt.female</span><span class="o">$</span><span class="n">nt</span><span class="o">/</span><span class="nf">max</span><span class="p">(</span><span class="n">lt.female</span><span class="o">$</span><span class="n">nt</span><span class="p">)</span><span class="w">
</span><span class="n">lt.female</span><span class="o">$</span><span class="n">pt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lt.female</span><span class="o">$</span><span class="n">qt</span><span class="w">
</span><span class="n">lt.female</span><span class="o">$</span><span class="n">lambdat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="nf">log</span><span class="p">(</span><span class="n">lt.female</span><span class="o">$</span><span class="n">pt</span><span class="p">)</span><span class="w">

</span><span class="c1"># plot survival curves</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">lt.female</span><span class="o">$</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">lt.female</span><span class="o">$</span><span class="n">lt</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="o">=</span><span class="s2">"US Survival 2011"</span><span class="p">,</span><span class="w">
     </span><span class="n">xlab</span><span class="o">=</span><span class="s2">"Age (years)"</span><span class="p">,</span><span class="n">ylab</span><span class="o">=</span><span class="s2">"Fraction Surviving"</span><span class="p">)</span><span class="w">
</span><span class="n">lines</span><span class="p">(</span><span class="n">lt.male</span><span class="o">$</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">lt.male</span><span class="o">$</span><span class="n">lt</span><span class="p">,</span><span class="n">col</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-08-oyo-advanced-survival-analysis-unnamed-chunk-5-1.png" title="plot of chunk unnamed-chunk-5" alt="plot of chunk unnamed-chunk-5" width="612" style="display: block; margin: auto;" /></p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot age-specific mortality</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">lt.female</span><span class="o">$</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">lt.female</span><span class="o">$</span><span class="n">lambdat</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">,</span><span class="w">
     </span><span class="n">col</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span><span class="n">log</span><span class="o">=</span><span class="s2">"y"</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="o">=</span><span class="s2">"US Age-Specific Mortality 2011"</span><span class="p">,</span><span class="w">
     </span><span class="n">xlab</span><span class="o">=</span><span class="s2">"Age (years)"</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="o">=</span><span class="s2">"Age-Specific mortality"</span><span class="p">)</span><span class="w">
</span><span class="n">lines</span><span class="p">(</span><span class="n">lt.male</span><span class="o">$</span><span class="n">t</span><span class="p">,</span><span class="w"> </span><span class="n">lt.male</span><span class="o">$</span><span class="n">lambdat</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-08-oyo-advanced-survival-analysis-unnamed-chunk-5-2.png" title="plot of chunk unnamed-chunk-5" alt="plot of chunk unnamed-chunk-5" width="612" style="display: block; margin: auto;" /></p>
  </blockquote>
</blockquote>

<p> </p>

<blockquote class="challenge">
  <h2 id="leukemia--log-rank-test-survdiff-function">Leukemia – log-rank test (survdiff function)</h2>

  <p>The survival package includes the Acute Myelogenous Leukemia (AML) survival dataset.
Open the help for <code class="language-plaintext highlighter-rouge">aml</code> for a description of the data. the “x” column indicates whether
a particular chemotherapy treatment was continued/maintained or discontinued.</p>

  <ol>
    <li>Open and examine the data, and plot a Kaplan-Meier curve for all data.</li>
    <li>Plot the Kaplan-Meier curves broken down by treatment, and calculate the
Log-Rank P-value to determine whether the differences are signifcant.</li>
    <li>Extra challenge: extract the life tables for treated and untreated individuals
and plot age-specific morality</li>
  </ol>

  <p>The data is stored in the <code class="language-plaintext highlighter-rouge">aml</code> dataframe, which is loaded with the <code class="language-plaintext highlighter-rouge">survival</code> package.</p>

  <p>*Note: unlike our mouse data, the <code class="language-plaintext highlighter-rouge">status</code> variable indicates whether a patient has died,
not patients that were censored. Be sure to indicate this appropriately in the <code class="language-plaintext highlighter-rouge">Surv()</code> 
object: <code class="language-plaintext highlighter-rouge">Surv(time, status == 1)</code>.</p>

  <blockquote class="solution">
    <h2 id="solution-1">Solution</h2>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load the survival package</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"survival"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Examine the data</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">aml</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  time status          x
1    9      1 Maintained
2   13      1 Maintained
3   13      0 Maintained
4   18      1 Maintained
5   23      1 Maintained
6   28      0 Maintained
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create the life table for the aml data (all combined)</span><span class="w">
</span><span class="n">survfit.aml</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survfit</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">aml</span><span class="p">)</span><span class="w">

</span><span class="n">summary</span><span class="p">(</span><span class="n">survfit.aml</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Call: survfit(formula = Surv(time, status == 1) ~ 1, data = aml)

 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    5     23       2   0.9130  0.0588       0.8049        1.000
    8     21       2   0.8261  0.0790       0.6848        0.996
    9     19       1   0.7826  0.0860       0.6310        0.971
   12     18       1   0.7391  0.0916       0.5798        0.942
   13     17       1   0.6957  0.0959       0.5309        0.912
   18     14       1   0.6460  0.1011       0.4753        0.878
   23     13       2   0.5466  0.1073       0.3721        0.803
   27     11       1   0.4969  0.1084       0.3240        0.762
   30      9       1   0.4417  0.1095       0.2717        0.718
   31      8       1   0.3865  0.1089       0.2225        0.671
   33      7       1   0.3313  0.1064       0.1765        0.622
   34      6       1   0.2761  0.1020       0.1338        0.569
   43      5       1   0.2208  0.0954       0.0947        0.515
   45      4       1   0.1656  0.0860       0.0598        0.458
   48      2       1   0.0828  0.0727       0.0148        0.462
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot the basic Kaplan-Meier curve for aml. Don't print the confidence interval.</span><span class="w">
</span><span class="c1"># We'll leave the 95% confidence intervals in place for fun.</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">survfit.aml</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Time (weeks)"</span><span class="p">,</span><span class="w"> 
     </span><span class="n">ylab</span><span class="o">=</span><span class="s2">"Fraction surviving"</span><span class="p">,</span><span class="w"> 
     </span><span class="n">mark.time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> 
     </span><span class="n">main</span><span class="o">=</span><span class="s2">"Survival in AML"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-08-oyo-advanced-survival-analysis-unnamed-chunk-6-1.png" title="plot of chunk unnamed-chunk-6" alt="plot of chunk unnamed-chunk-6" width="612" style="display: block; margin: auto;" /></p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create aml life tables and KM plots broken out by treatment (x,  "Maintained" vs. "Not maintained")</span><span class="w">
</span><span class="n">survfit.aml.by.rx</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survfit</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">aml</span><span class="p">)</span><span class="w">
</span><span class="n">summary</span><span class="p">(</span><span class="n">survfit.aml.by.rx</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Call: survfit(formula = Surv(time, status == 1) ~ x, data = aml)

                x=Maintained 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    9     11       1    0.909  0.0867       0.7541        1.000
   13     10       1    0.818  0.1163       0.6192        1.000
   18      8       1    0.716  0.1397       0.4884        1.000
   23      7       1    0.614  0.1526       0.3769        0.999
   31      5       1    0.491  0.1642       0.2549        0.946
   34      4       1    0.368  0.1627       0.1549        0.875
   48      2       1    0.184  0.1535       0.0359        0.944

                x=Nonmaintained 
 time n.risk n.event survival std.err lower 95% CI upper 95% CI
    5     12       2   0.8333  0.1076       0.6470        1.000
    8     10       2   0.6667  0.1361       0.4468        0.995
   12      8       1   0.5833  0.1423       0.3616        0.941
   23      6       1   0.4861  0.1481       0.2675        0.883
   27      5       1   0.3889  0.1470       0.1854        0.816
   30      4       1   0.2917  0.1387       0.1148        0.741
   33      3       1   0.1944  0.1219       0.0569        0.664
   43      2       1   0.0972  0.0919       0.0153        0.620
   45      1       1   0.0000     NaN           NA           NA
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot KM broken out by treatment </span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">survfit.aml.by.rx</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Time"</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="o">=</span><span class="s2">"Survival"</span><span class="p">,</span><span class="w">
     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="s2">"red"</span><span class="p">),</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">,</span><span class="w"> 
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Kaplan-Meier Survival vs. Maintenance in AML"</span><span class="p">)</span><span class="w">

</span><span class="c1"># Add a legend so we know which is which</span><span class="w">
</span><span class="n">legend</span><span class="p">(</span><span class="s2">"topright"</span><span class="p">,</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Maintained"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Not maintained"</span><span class="p">),</span><span class="w"> 
       </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="s2">"red"</span><span class="p">))</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-08-oyo-advanced-survival-analysis-unnamed-chunk-6-2.png" title="plot of chunk unnamed-chunk-6" alt="plot of chunk unnamed-chunk-6" width="612" style="display: block; margin: auto;" /></p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Perform the log rank test using the R function survdiff().</span><span class="w">
</span><span class="n">aml.survdiff</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">data</span><span class="o">=</span><span class="n">aml</span><span class="p">)</span><span class="w">
</span><span class="n">aml.survdiff</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Call:
survdiff(formula = Surv(time, status == 1) ~ x, data = aml)

                 N Observed Expected (O-E)^2/E (O-E)^2/V
x=Maintained    11        7    10.69      1.27       3.4
x=Nonmaintained 12       11     7.31      1.86       3.4

 Chisq= 3.4  on 1 degrees of freedom, p= 0.07 
</code></pre></div>    </div>

    <p>Extra challenge: calculate and plot age-specific mortality (\(\mu_x\)) for 
the above groups.</p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># first we need to assign the life table summary to an object</span><span class="w">
</span><span class="n">aml.lt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">summary</span><span class="p">(</span><span class="n">survfit.aml.by.rx</span><span class="p">)</span><span class="w">

</span><span class="c1"># extract age, and number of deaths and number at risk at each age from the</span><span class="w">
</span><span class="c1"># survfit object. We'll do the "Maintained" group first. For some reason the summary</span><span class="w">
</span><span class="c1"># is formatted in rows with a weird notation. It creates a new variable that combines</span><span class="w">
</span><span class="c1"># the header from our original input data with the value in the column; in this case</span><span class="w">
</span><span class="c1"># "x=Maintained" and "x=Nonmaintained". We have to use this to separate out the data</span><span class="w">
</span><span class="n">age.main</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">aml.lt</span><span class="o">$</span><span class="n">time</span><span class="p">[</span><span class="n">aml.lt</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"x=Maintained"</span><span class="p">]</span><span class="w">
</span><span class="n">n.event.main</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">aml.lt</span><span class="o">$</span><span class="n">n.event</span><span class="p">[</span><span class="n">aml.lt</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"x=Maintained"</span><span class="p">]</span><span class="w">
</span><span class="n">n.risk.main</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">aml.lt</span><span class="o">$</span><span class="n">n.risk</span><span class="p">[</span><span class="n">aml.lt</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"x=Maintained"</span><span class="p">]</span><span class="w">

</span><span class="c1"># calculate qt; note that this is an alternative way to get qx from using the lx and</span><span class="w">
</span><span class="c1"># lx+1 values. If you rearrange the life table equations you can derive this form.</span><span class="w">
</span><span class="n">qx.main</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">n.event.main</span><span class="o">/</span><span class="n">n.risk.main</span><span class="w">

</span><span class="c1"># now calculate px and mux (mu is age-specific mortality)</span><span class="w">
</span><span class="n">px.main</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">qx.main</span><span class="w">
</span><span class="n">mux.main</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="nf">log</span><span class="p">(</span><span class="n">px.main</span><span class="p">)</span><span class="w">

</span><span class="c1"># for the non-maintenance group, I am just going to combine the above few steps</span><span class="w">
</span><span class="c1"># into a single step.</span><span class="w">
</span><span class="n">age.nomain</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">aml.lt</span><span class="o">$</span><span class="n">time</span><span class="p">[</span><span class="n">aml.lt</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"x=Nonmaintained"</span><span class="p">]</span><span class="w">
</span><span class="n">mux.nomain</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">-</span><span class="nf">log</span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">aml.lt</span><span class="o">$</span><span class="n">n.event</span><span class="p">[</span><span class="n">aml.lt</span><span class="o">$</span><span class="n">strata</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"x=Nonmaintained"</span><span class="p">]</span><span class="o">/</span><span class="n">aml.lt</span><span class="o">$</span><span class="n">n.risk</span><span class="p">[</span><span class="n">aml.lt</span><span class="o">$</span><span class="n">strata</span><span class="w"> 
</span><span class="o">==</span><span class="w"> </span><span class="s2">"x=Nonmaintained"</span><span class="p">])</span><span class="w">

</span><span class="c1"># Now we can finally plot. Someone should write a function to do this...</span><span class="w">
</span><span class="c1"># Remember to put the y-axis on a log scale.</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">age.main</span><span class="p">,</span><span class="n">mux.main</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"y"</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"o"</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.7</span><span class="p">,</span><span class="w">  
     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Age"</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Age-Specific Mortality"</span><span class="p">,</span><span class="w">
     </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">min</span><span class="p">(</span><span class="n">aml.lt</span><span class="o">$</span><span class="n">time</span><span class="p">),</span><span class="nf">max</span><span class="p">(</span><span class="n">aml.lt</span><span class="o">$</span><span class="n">time</span><span class="p">)))</span><span class="w">
</span><span class="n">lines</span><span class="p">(</span><span class="n">age.nomain</span><span class="p">,</span><span class="n">mux.nomain</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"o"</span><span class="p">,</span><span class="w"> </span><span class="n">pch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">16</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.7</span><span class="p">)</span><span class="w">
</span><span class="n">legend</span><span class="p">(</span><span class="s2">"bottomright"</span><span class="p">,</span><span class="n">legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Maintained"</span><span class="p">,</span><span class="s2">"Nonmaintained"</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"blue"</span><span class="p">,</span><span class="s2">"red"</span><span class="p">))</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-08-oyo-advanced-survival-analysis-unnamed-chunk-7-1.png" title="plot of chunk unnamed-chunk-7" alt="plot of chunk unnamed-chunk-7" width="612" style="display: block; margin: auto;" /></p>
  </blockquote>
</blockquote>

<p> </p>

<blockquote class="challenge">
  <h2 id="revisiting-levamisole-treatment-in-colon-cancer">Revisiting levamisole treatment in colon cancer</h2>

  <p><em>In Class</em> we looked at the colon cancer dataset (<code class="language-plaintext highlighter-rouge">colon</code>) that is included 
with the <code class="language-plaintext highlighter-rouge">survival</code> package in R, and concluded that this dataset supports 
the idea that levamisole treatment improves survival in colon cancer 
patients when combined with 5-FU. Let’s take a closer look at the data and 
see what more we can learn.</p>

  <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="s2">"survival"</span><span class="p">)</span><span class="w"> </span><span class="c1"># make sure you have the library loaded</span><span class="w">
</span><span class="n">str</span><span class="p">(</span><span class="n">colon</span><span class="p">)</span><span class="w">
</span></code></pre></div>  </div>

  <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'data.frame':	1858 obs. of  16 variables:
 $ id      : num  1 1 2 2 3 3 4 4 5 5 ...
 $ study   : num  1 1 1 1 1 1 1 1 1 1 ...
 $ rx      : Factor w/ 3 levels "Obs","Lev","Lev+5FU": 3 3 3 3 1 1 3 3 1 1 ...
 $ sex     : num  1 1 1 1 0 0 0 0 1 1 ...
 $ age     : num  43 43 63 63 71 71 66 66 69 69 ...
 $ obstruct: num  0 0 0 0 0 0 1 1 0 0 ...
 $ perfor  : num  0 0 0 0 0 0 0 0 0 0 ...
 $ adhere  : num  0 0 0 0 1 1 0 0 0 0 ...
 $ nodes   : num  5 5 1 1 7 7 6 6 22 22 ...
 $ status  : num  1 1 0 0 1 1 1 1 1 1 ...
 $ differ  : num  2 2 2 2 2 2 2 2 2 2 ...
 $ extent  : num  3 3 3 3 2 2 3 3 3 3 ...
 $ surg    : num  0 0 0 0 0 0 1 1 1 1 ...
 $ node4   : num  1 1 0 0 1 1 1 1 1 1 ...
 $ time    : num  1521 968 3087 3087 963 ...
 $ etype   : num  2 1 2 1 2 1 2 1 2 1 ...
</code></pre></div>  </div>

  <p> </p>

  <p>Based on the <code class="language-plaintext highlighter-rouge">?colon</code> description, in addition to the information on 
recurrence and survival, we have data on the differention status of the 
tumor cells, an indicator of tumor grade (poorly differentiated tumors are 
higher grade and more aggressive) stored in the <code class="language-plaintext highlighter-rouge">differ</code> variable.</p>

  <p>How does the effectiveness of levamisole at prolonging survival differ 
across patients with different tumor grades?</p>

  <blockquote class="solution">
    <h2 id="hint">Hint</h2>

    <p>If you examine the <code class="language-plaintext highlighter-rouge">differ</code> variable, we don’t have data on tumor grade for
all patients. In this case, we will want to remove all <code class="language-plaintext highlighter-rouge">NA</code> values from the &gt; &gt; data set up front.</p>
  </blockquote>

  <blockquote class="solution">
    <h2 id="solution-2">Solution</h2>

    <p>Again, we will start by taking a look at the survival curves for each tumor grade. We can do this using a <code class="language-plaintext highlighter-rouge">for</code> loop and building a 3-panel figure:.</p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># like before, we will grab just the subset of data for the "death" events, </span><span class="w">
</span><span class="c1"># since we are not looking at recurrence in this exercise</span><span class="w">
</span><span class="n">colon.death</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colon</span><span class="p">[</span><span class="n">colon</span><span class="o">$</span><span class="n">etype</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">2</span><span class="p">,]</span><span class="w">

</span><span class="c1"># note that some patients do not have information on tumor grade. There are </span><span class="w">
</span><span class="c1"># various ways to look at this, but let's use the table function with useNA</span><span class="w">
</span><span class="c1"># set to "ifany". You could also just display the `differ` variable, or </span><span class="w">
</span><span class="c1"># use `any(isNA(colon.death$differ))`</span><span class="w">
</span><span class="n">table</span><span class="p">(</span><span class="n">colon.death</span><span class="p">[,</span><span class="nf">c</span><span class="p">(</span><span class="s2">"rx"</span><span class="p">,</span><span class="s2">"differ"</span><span class="p">)],</span><span class="w"> </span><span class="n">useNA</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ifany"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>         differ
rx          1   2   3 &lt;NA&gt;
  Obs      27 229  52    7
  Lev      37 219  44   10
  Lev+5FU  29 215  54    6
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The data from these patients will not be useful in our analysis, so we </span><span class="w">
</span><span class="c1"># should remove them up front. We can do this using either != NA, or `is.na()`</span><span class="w">
</span><span class="n">colon.differ</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colon.death</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">colon.death</span><span class="o">$</span><span class="n">differ</span><span class="p">),]</span><span class="w">

</span><span class="c1"># first setup a 3 panel figure</span><span class="w">
</span><span class="n">par</span><span class="p">(</span><span class="n">mfrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">3</span><span class="p">))</span><span class="w">

</span><span class="c1"># start a for loop to cycle through each unique value of the differ variable</span><span class="w">
</span><span class="c1"># I am also including `sort()` to place the values in numeric order (grade 1 </span><span class="w">
</span><span class="c1"># first)</span><span class="w">
</span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">sort</span><span class="p">(</span><span class="n">colon.death</span><span class="o">$</span><span class="n">differ</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># grab data subset for just the current tumor grade</span><span class="w">
  </span><span class="n">colon.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colon.differ</span><span class="p">[</span><span class="n">colon.death</span><span class="o">$</span><span class="n">differ</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="p">,]</span><span class="w">
  
  </span><span class="c1"># build a survfit object subsetting the data from colon by treatment</span><span class="w">
  </span><span class="n">survfit.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survfit</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">rx</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colon.c</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># plot the Kaplan-Meier curves for the two data sets, showing censored</span><span class="w">
  </span><span class="c1"># individuals as markers</span><span class="w">
  </span><span class="n">plot</span><span class="p">(</span><span class="n">survfit.c</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"red"</span><span class="p">),</span><span class="w"> </span><span class="n">mark.time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w">
     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Time since treatment"</span><span class="p">,</span><span class="w">
     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Fraction surviving"</span><span class="p">,</span><span class="w">
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"Tumor Grade "</span><span class="p">,</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="c1"># add a label for the current grade</span><span class="w">
  </span><span class="n">legend</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottomleft"</span><span class="p">,</span><span class="w"> 
     </span><span class="n">legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"observation"</span><span class="p">,</span><span class="s2">"levamisole"</span><span class="p">,</span><span class="s2">"levamisole + 5-FU"</span><span class="p">),</span><span class="w"> </span><span class="c1"># order labels in the order of levels(colon.death)</span><span class="w">
     </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">,</span><span class="w"> </span><span class="s2">"red"</span><span class="p">))</span><span class="w"> </span><span class="c1"># generate lines of the right colors</span><span class="w">

</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-08-oyo-advanced-survival-analysis-unnamed-chunk-9-1.png" title="plot of chunk unnamed-chunk-9" alt="plot of chunk unnamed-chunk-9" width="612" style="display: block; margin: auto;" /></p>

    <p> </p>

    <p>The treatment pattern for grades 1 and 2 look similar to the whole popoulation. In patients with grade 3 tumors, it appears that levamisole may have efficacy on it’s own. Let’s check that out.</p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># grab the subset for grade 3 tumors</span><span class="w">
</span><span class="n">colon.3</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colon.differ</span><span class="p">[</span><span class="n">colon.differ</span><span class="o">$</span><span class="n">differ</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">3</span><span class="p">,]</span><span class="w">

</span><span class="c1"># use survdiff() to run log-rank test between groups after subsetting</span><span class="w">
</span><span class="c1"># for each comparison</span><span class="w">
</span><span class="n">logrank.lev.vs.ctrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">rx</span><span class="p">,</span><span class="w"> 
                                </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colon.3</span><span class="p">[</span><span class="n">colon.death</span><span class="o">$</span><span class="n">rx</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Obs"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Lev"</span><span class="p">),])</span><span class="w">
</span><span class="n">logrank.comb.vs.ctrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">rx</span><span class="p">,</span><span class="w"> 
                                </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colon.3</span><span class="p">[</span><span class="n">colon.death</span><span class="o">$</span><span class="n">rx</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Obs"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Lev+5FU"</span><span class="p">),])</span><span class="w">
</span><span class="n">logrank.comb.vs.lev</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">rx</span><span class="p">,</span><span class="w"> 
                                </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">colon.3</span><span class="p">[</span><span class="n">colon.death</span><span class="o">$</span><span class="n">rx</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Lev"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Lev+5FU"</span><span class="p">),])</span><span class="w">

</span><span class="n">logrank.lev.vs.ctrl</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Call:
survdiff(formula = Surv(time, status) ~ rx, data = colon.3[colon.death$rx %in% 
    c("Obs", "Lev"), ])

n=103, 522 observations deleted due to missingness.

            N Observed Expected (O-E)^2/E (O-E)^2/V
rx=Obs     36       25     20.8     0.838     1.283
rx=Lev     35       21     19.8     0.075     0.111
rx=Lev+5FU 32       15     20.4     1.428     2.160

 Chisq= 2.4  on 2 degrees of freedom, p= 0.3 
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">logrank.comb.vs.ctrl</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Call:
survdiff(formula = Surv(time, status) ~ rx, data = colon.3[colon.death$rx %in% 
    c("Obs", "Lev+5FU"), ])

n=102, 517 observations deleted due to missingness.

            N Observed Expected (O-E)^2/E (O-E)^2/V
rx=Obs     36       22     20.9    0.0628    0.0974
rx=Lev     28       17     15.3    0.1958    0.2644
rx=Lev+5FU 38       20     22.9    0.3610    0.5913

 Chisq= 0.6  on 2 degrees of freedom, p= 0.7 
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">logrank.comb.vs.lev</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Call:
survdiff(formula = Surv(time, status) ~ rx, data = colon.3[colon.death$rx %in% 
    c("Lev", "Lev+5FU"), ])

n=95, 519 observations deleted due to missingness.

            N Observed Expected (O-E)^2/E (O-E)^2/V
rx=Obs     32       21     19.3     0.149     0.229
rx=Lev     25       16     14.4     0.177     0.238
rx=Lev+5FU 38       19     22.3     0.486     0.811

 Chisq= 0.8  on 2 degrees of freedom, p= 0.7 
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># now we can extract each P-value using the chisq statistic and distribtion</span><span class="w">
</span><span class="n">P.lev.vs.ctrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pchisq</span><span class="p">(</span><span class="n">logrank.lev.vs.ctrl</span><span class="o">$</span><span class="n">chisq</span><span class="p">,</span><span class="w"> 
                        </span><span class="nf">length</span><span class="p">(</span><span class="n">logrank.lev.vs.ctrl</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">lower.tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
</span><span class="n">P.comb.vs.ctrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pchisq</span><span class="p">(</span><span class="n">logrank.comb.vs.ctrl</span><span class="o">$</span><span class="n">chisq</span><span class="p">,</span><span class="w"> 
                        </span><span class="nf">length</span><span class="p">(</span><span class="n">logrank.comb.vs.ctrl</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">lower.tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
</span><span class="n">P.comb.vs.lev</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pchisq</span><span class="p">(</span><span class="n">logrank.comb.vs.lev</span><span class="o">$</span><span class="n">chisq</span><span class="p">,</span><span class="w"> 
                        </span><span class="nf">length</span><span class="p">(</span><span class="n">logrank.comb.vs.lev</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> 
                        </span><span class="n">lower.tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">

</span><span class="c1"># and correct for the multiple comparison</span><span class="w">
</span><span class="n">P.colon</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">P.lev.vs.ctrl</span><span class="p">,</span><span class="w"> </span><span class="n">P.comb.vs.ctrl</span><span class="p">,</span><span class="w"> </span><span class="n">P.comb.vs.lev</span><span class="p">)</span><span class="w">
</span><span class="n">P.colon.corrected</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">p.adjust</span><span class="p">(</span><span class="n">P.colon</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"holm"</span><span class="p">)</span><span class="w">
</span><span class="n">P.colon.corrected</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 0.9208073 1.0000000 1.0000000
</code></pre></div>    </div>

    <p> </p>

    <p>Well, the P-values do not allow us to reject the null hypotheses 
associated with each test (no differen between groups). The survival 
curves still look promising, and given the relatively low patient 
numbers with grade 3 cancer, this dataset may simply be underpowered. 
Levamisole as a monotherapy for aggressive colon cancer may be worth 
another look.</p>
  </blockquote>
</blockquote>

<p> </p>

<blockquote class="challenge">
  <h2 id="challenge-comparison-of-female-vs-male-lifespan-across-strains">Challenge: comparison of female vs. male lifespan across strains</h2>

  <p>We saw that lifespan was not significanlty different between female and male BUB/BnJ mice.
Is this universally true for different mouse strains?</p>

  <p>Write a script that does the following using the <code class="language-plaintext highlighter-rouge">inbred.lifespan.txt</code> data:</p>
  <ol>
    <li>Generate a PDF.</li>
    <li>On each page, plot female vs. male lifespan and mortality curves for one strain. Include
the following on each plot (hint: use the <code class="language-plaintext highlighter-rouge">text()</code> or <code class="language-plaintext highlighter-rouge">mtext()</code> functions):
      <ul>
        <li>strain name</li>
        <li>Log-Rank P-value</li>
        <li>Tick marks to indicate time of censoring</li>
        <li>Legend to show female vs. male colors</li>
      </ul>
    </li>
  </ol>

  <p>The goal here is to combine concepts from across the early section of the class 
to generate a novel analysis pipeline and apply it repeatedly to similar data 
sets (i.e. different mouse strains) using R to do the heavy lifting.</p>

  <blockquote class="solution">
    <h2 id="solution-3">Solution</h2>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load survival package (if you don't already have it loaded)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"survival"</span><span class="p">)</span><span class="w">

</span><span class="c1"># read in inbred strain lifespan data</span><span class="w">
</span><span class="n">data.surv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.delim</span><span class="p">(</span><span class="s2">"data/inbred.lifespan.txt"</span><span class="p">)</span><span class="w">

</span><span class="c1"># extract the list of strains in our data set</span><span class="w">
</span><span class="n">strain.list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unique</span><span class="p">(</span><span class="n">data.surv</span><span class="o">$</span><span class="n">strain</span><span class="p">)</span><span class="w">

</span><span class="c1"># initialize our PDF file with a 3" x 5" plot area (size is up to you)</span><span class="w">
</span><span class="n">pdf</span><span class="p">(</span><span class="s2">"results/inbred.lifespan.by.strain.pdf"</span><span class="p">,</span><span class="w">
    </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)</span><span class="w">

</span><span class="c1"># cycle through each strain in the strain list to</span><span class="w">
</span><span class="k">for</span><span class="p">(</span><span class="n">i.strain</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">strain.list</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># grab the name of the current strain</span><span class="w">
  </span><span class="n">strain.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">strain.list</span><span class="p">[</span><span class="n">i.strain</span><span class="p">]</span><span class="w">
  
  </span><span class="c1"># grab the subset of the lifespan data for the current strain</span><span class="w">
  </span><span class="n">data.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.surv</span><span class="p">[</span><span class="n">data.surv</span><span class="o">$</span><span class="n">strain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">strain.c</span><span class="p">,]</span><span class="w">

  </span><span class="c1"># calculate life table for the current strain</span><span class="w">
  </span><span class="n">survfit.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survfit</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan_days</span><span class="p">,</span><span class="w"> </span><span class="n">censor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">sex</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">data.c</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># check to see if this strain has data for both sexes. When you try to </span><span class="w">
  </span><span class="c1"># skip this step, your logrank function will throw an error for CAST/EiJ,</span><span class="w">
  </span><span class="c1"># which only has data for female mice. There are various ways to do this,</span><span class="w">
  </span><span class="c1"># but I just checked to make sure that there were more than one values in </span><span class="w">
  </span><span class="c1"># the "sex" column for the current strain. If there is only 1 value, set</span><span class="w">
  </span><span class="c1"># the p-value to 1 by default, otherwise calculate it.</span><span class="w">
  </span><span class="k">if</span><span class="p">(</span><span class="nf">length</span><span class="p">(</span><span class="n">unique</span><span class="p">(</span><span class="n">data.c</span><span class="o">$</span><span class="n">sex</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1"># run the logrank test using the survdiff() function</span><span class="w">
    </span><span class="n">logrank.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan_days</span><span class="p">,</span><span class="w"> </span><span class="n">censor</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">sex</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data.c</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># extract the chi-squared statistic and number of groups from the survdiff</span><span class="w">
    </span><span class="c1"># object</span><span class="w">
    </span><span class="n">chisq.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">logrank.c</span><span class="o">$</span><span class="n">chisq</span><span class="w">
    </span><span class="n">n.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">logrank.c</span><span class="o">$</span><span class="n">n</span><span class="w">
    
    </span><span class="c1"># use these value to calculate the P-value from the chi-squared distribution</span><span class="w">
    </span><span class="n">P.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pchisq</span><span class="p">(</span><span class="n">chisq.c</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">n.c</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lower.tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1"># if there is only 1 sex in the current strain dataset, set p = 1</span><span class="w">
    </span><span class="n">P.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="c1"># Plot the Kaplan-Meier curve</span><span class="w">
  </span><span class="n">plot</span><span class="p">(</span><span class="n">survfit.c</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Age (days)"</span><span class="p">,</span><span class="w"> 
       </span><span class="n">ylab</span><span class="o">=</span><span class="s2">"Fraction surviving"</span><span class="p">,</span><span class="w"> 
       </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"red"</span><span class="p">,</span><span class="s2">"blue"</span><span class="p">),</span><span class="w">
       </span><span class="n">conf.int</span><span class="o">=</span><span class="kc">FALSE</span><span class="p">,</span><span class="w">              </span><span class="c1"># turn of confidence intervals</span><span class="w">
       </span><span class="n">mark.time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">            </span><span class="c1"># mark time of censor</span><span class="w">
       </span><span class="n">main</span><span class="o">=</span><span class="n">paste0</span><span class="p">(</span><span class="n">strain.c</span><span class="p">,</span><span class="s2">" Lifespan"</span><span class="p">))</span><span class="w">
  
  </span><span class="c1"># add legend</span><span class="w">
  </span><span class="n">legend</span><span class="p">(</span><span class="s2">"topright"</span><span class="p">,</span><span class="w"> </span><span class="n">lty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w">
         </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"red"</span><span class="p">,</span><span class="s2">"blue"</span><span class="p">),</span><span class="w">
         </span><span class="n">legend</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"f"</span><span class="p">,</span><span class="s2">"m"</span><span class="p">))</span><span class="w">  
  
  </span><span class="c1"># add P value to plot (you can use either text or mtext here).</span><span class="w">
  </span><span class="c1"># I used round() to limit the number of decimal places printed.</span><span class="w">
  </span><span class="n">mtext</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="s2">"P = "</span><span class="p">,</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">P.c</span><span class="p">,</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4</span><span class="p">)),</span><span class="w"> 
        </span><span class="n">side</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="c1"># print on the bottom</span><span class="w">
        </span><span class="n">line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1.2</span><span class="p">,</span><span class="w"> </span><span class="c1"># use negative numbers to move "inward"/up on the plot</span><span class="w">
        </span><span class="n">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="c1"># bold font</span><span class="w">
        </span><span class="n">adj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.03</span><span class="p">)</span><span class="w"> </span><span class="c1"># left justify (0) plus a bit (0.03) to print in bottom left</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1"># turn off PDF graphics device</span><span class="w">
</span><span class="n">dev.off</span><span class="p">()</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>png 
  2 
</code></pre></div>    </div>
  </blockquote>
</blockquote>

<hr />



<blockquote class="keypoints">
  <h2>Key Points</h2>
  <ul>
    
    <li><p>The <code class="language-plaintext highlighter-rouge">survfit()</code> function creates a complex object in R containing life table information. This data can be extracted using the <code class="language-plaintext highlighter-rouge">strata</code> variable.</p>
</li>
    
    <li><p>Once extracted, the life table data can be used to calculate and plot age-specific mortality (don’t forget to use log scale on your y-axis!).</p>
</li>
    
  </ul>
</blockquote>

</article>
















<div class="row">
  <div class="col-xs-1">
    <h3 class="text-left">
      
      <a href="../08-class-survival-analysis/index.html"><span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span><span class="sr-only">previous episode</span></a>
      
    </h3>
  </div>
  <div class="col-xs-10">
    
  </div>
  <div class="col-xs-1">
    <h3 class="text-right">
      
      <a href="../09-class-power-analysis/index.html"><span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span><span class="sr-only">next episode</span></a>
      
    </h3>
  </div>
</div>


      
      






<footer>
  <!--<div class="row">
    <div class="col-md-6 copyright" align="left">
	
    </div>
    <div class="col-md-6 help-links" align="right">
	
	
	<a href="/edit//_episodes_rmd/08-oyo-advanced-survival-analysis.Rmd">Edit on GitHub</a>
	
	
	/
	<a href="/blob//CONTRIBUTING.md">Contributing</a>
	/
	<a href="/">Source</a>
	/
	<a href="/blob//CITATION">Cite</a>
	/
	<a href="mailto:sutphin@gmail.com">Contact</a>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12" align="center">
      Using <a href="https://github.com/carpentries/styles/">The Carpentries style</a>
      version <a href="https://github.com/carpentries/styles/releases/tag/v9.5.3">9.5.3</a>.
    </div>
  </div>-->
</footer>

      
    </div>
    
<script src="../assets/js/jquery.min.js"></script>
<script src="../assets/js/bootstrap.min.js"></script>
<script src="../assets/js/lesson.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-37305346-2', 'auto');
  ga('send', 'pageview');
</script>
<!--<script type="text/javascript"
  src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>-->
<script type="text/javascript"
src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

  </body>
</html>
