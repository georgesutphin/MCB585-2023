I"ôâ<h2 id="on-your-own">On Your Own</h2>

<p><em>In Class</em> we looked at how to conduct a basic power analysis using a t-test. This process relies on the same assumptions that go into a t-test, and in particular that we understand the properties of a t distribution, which is related to the normal distribution. For simple experimental designs‚Äìcomparing normally distributed phenotype(s) in samples taken randomly and independently from two groups‚Äìthis process works great.</p>

<p>What happens when our phenotype or experimental design breaks one of the assumptions of a t-test? Maybe our data is not normal; maybe we have a more complex sampling strategy; maybe we are looking at the interaction between multiple phenotypes across time or some other dimension. What do we do now?</p>

<p>In essence, what the power analysis is doing is asking the following:</p>

<table>
  <tbody>
    <tr>
      <td><em>If I run my experiment 10,000 times, in what fraction of those experiments can I expect to detect a difference when a difference exists?</em></td>
    </tr>
  </tbody>
</table>

<p>Wouldn‚Äôt it be nice if we could do just that: run our experiment 10,000 times and see what happens? Well, in a way, we can. We do so by making some basic assumptions and running a simulation. In fact, simulations can give insights beyond mere power.</p>

<hr />
<h3 id="simulating-experiments-in-advance">Simulating experiments in advance</h3>

<p>Simulations have several advantages, for example:</p>
<ul>
  <li>
    <p>The force you to think through a planned statistical analysis in advance (for best practices, you should be doing this anyway) and work out at least some of the technical issues ahead of time.</p>
  </li>
  <li>
    <p>They give valuable insight into the behavior the phenotype that you are studying.</p>
  </li>
  <li>
    <p>They can identify problems with experimental design or practical execution that you would not have considered in advance otherwise.</p>
  </li>
</ul>

<p>Here we are going to use a simulation to run a more generalized form of power analysis. Unlike the functions in the <code class="language-plaintext highlighter-rouge">pwr</code> package, this method can be used on essentially any experimental design for which you have pilot data (or not, assuming you can make a reasonable estimate of the behavior of the phenotype of interest). It does not necessarily rely on specific assumptions about the distribution or nature of the phenotype, though <em>some</em> assumptions will always be required.</p>

<hr />
<h3 id="using-simulations-to-conduct-power-analyses">Using simulations to conduct power analyses</h3>

<p>In a power analysis, we are usually trying to figure out what sample size we need to be confident in the statistical outcome of an experiment. Why don‚Äôt we just run the experiment a bunch of times to see how often we expect different outcomes to occur? Because we have limited resources, going to the bench and physcially repeating an experiment a hundred or a thousand times is not practical. We usually have the time and resources to run an experiment once (or at most a few times), and we want to know how to get the most bang for our buck. That doesn‚Äôt mean we can‚Äôt pretend though.</p>

<p>In essence, a simulation is a formalized thought experiment, where we set up an idealized scenario where we know what the ‚Äúright‚Äù answer is (e.g. we define the population distribution), pretend to run our experiment over and over again, complete with sampling and statistical tests, and see how often our ‚Äúsingle‚Äù experiments can be expected to successfully detect the true background truth of the distribution.</p>

<p>Running a simulation is really not that difficult, but requires thinking through each of the steps that you will be taking in the real-world experiment and replicating those steps in code. This process will take advantage of most of the skills that we have developed over the past 5 weeks. Here is a basic protocol:</p>

<ol>
  <li>Estimate the behavior of the real phenotype of interest. Usually this involves collection pilot data and making an assumption along one of two lines:
    <ul>
      <li>Assume that the phenotype behaves according to a defined function or distribution and use the pilot data to estimate the exact shape (e.g. assume your phenotype is normally distributed, and use the mean and standard deviation of the pilot data to estimate the shape of the specific normal distribution).</li>
      <li>Assume that your pilot data is identical to your population and use it directly (this usually works if you have a lot of pilot data, say about your control population).</li>
    </ul>
  </li>
</ol>

<ol start="2">
  <li>
    <p>Decide what sort of change in your phenotype of interest is meaningful. Usually this involves making an assumption about how the independent variable will impact your dependent variable (e.g. I am interested in detecting a mean body weight change of 20% without a change in standard deviation).</p>
  </li>
  <li>
    <p>Using the information in (1) and (2), formally define your ‚Äúcontrol‚Äù and ‚Äútreatment‚Äù populations for the two situations that you are trying to distinguish with your hypothesis framing:</p>
    <ul>
      <li><strong>\(H_1\) is true:</strong> apply a transformation to your control distribution or data to simulate the impact of your independent variable (e.g. multiply the mean by 1.2 to simulate a 20% increase in mean value, then use that value to define the ‚Äútreatment‚Äù distribution).</li>
      <li><strong>\(H_0\) is true:</strong> under the null hypothesis, the independent variable does not impact the dependent variable. In this case, we will use the control distribution to draw both samples.</li>
    </ul>
  </li>
</ol>

<ol start="4">
  <li>Collect a simulated sample of size m and n from your control and treatment groups, respectively (note that m and n can be different). This usually involves drawing random values for the dependent variable from a distribution or pilot data set. Based on (3), we will actually be drawing 3 samples:
    <ul>
      <li>one ‚Äúcontrol‚Äù sample from our <em>control</em> population</li>
      <li>one ‚Äútreatment‚Äù sample from our <em>treatment</em> population, to simulate the scenario when \(H_1\) is true.</li>
      <li>one ‚Äútreatment‚Äù sample from our <em>control</em> population, to simulate the scenario when \(H_0\) is true.</li>
    </ul>
  </li>
</ol>

<ol start="5">
  <li>
    <p>Conduct a pre-defined statistical test on your ‚Äúcontrol‚Äù vs. ‚Äútreatment‚Äù samples for both scenarios (\(H_1\) is true and \(H_0\) is true) and note the outcome (i.e. the P-value and interpretation).</p>
  </li>
  <li>
    <p>Repeat steps (4) and (5) as many times as you like to simulate repeated experiments.</p>
  </li>
  <li>
    <p>Tabulate the number of times your statistical test accepted or rejected \(H_0\) under both scenarios (\(H_1\) is true and \(H_0\) is true) to generate a hypothesis table.</p>
  </li>
  <li>
    <p>Use the four quadrants of the hypothesis table to calculate your simulated \(\alpha\), \(\beta\), and power. At this stage you have effectively conducted a single <strong>power analysis</strong> analogous to what a single call of the <code class="language-plaintext highlighter-rouge">pwr.t.test()</code> function produces.</p>
  </li>
  <li>
    <p>Repeat steps (4) to (8) for additional effect sizes and sample sizes to draw power reference charts.</p>
  </li>
</ol>

<p>We now have the tools to conduct each step in this process, with the exception of how to sample data (step 4). Technically we did sample data when looking at normal distributions using the <code class="language-plaintext highlighter-rouge">rnorm()</code> function, but we will go through the process in more detail in order to re-examine our power analysis for mouse lifespan.</p>

<hr />
<h3 id="sampling-from-distributions">Sampling from distributions</h3>

<p>To demonstrate how to define a distribution based on pilot data and use that distribution to simulate drawing novel sampling data, we will use our inbred mouse lifespan data set to simulate new lifespan data for C57BL/6J mice.</p>

<p>First, load the <code class="language-plaintext highlighter-rouge">inbred.lifespan.txt</code> data and the <code class="language-plaintext highlighter-rouge">survival</code> package. Also define the ‚Äústatus‚Äù variable to indicate which mice had a positive observation for the phenotype of interest (death). Recall that this is just the inverse of the already defined <code class="language-plaintext highlighter-rouge">censor</code> variable, which indicates censoring events for mice that were removed from the study prior to dying. Finally, grab the subset of data for just the C57BL/6J mouse strain.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load library</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"survival"</span><span class="p">)</span><span class="w">

</span><span class="c1"># load inbred mouse lifespan data</span><span class="w">
</span><span class="n">data.surv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.delim</span><span class="p">(</span><span class="s2">"data/inbred.lifespan.txt"</span><span class="p">)</span><span class="w">

</span><span class="c1"># define status variable to indicate "death" events</span><span class="w">
</span><span class="n">data.surv</span><span class="o">$</span><span class="n">status</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="o">!</span><span class="n">data.surv</span><span class="o">$</span><span class="n">censor</span><span class="p">)</span><span class="w">

</span><span class="c1"># Grab C57BL/6J data subset</span><span class="w">
</span><span class="n">surv.b6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.surv</span><span class="p">[</span><span class="n">data.surv</span><span class="o">$</span><span class="n">strain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"C57BL/6J"</span><span class="p">,]</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">surv.b6</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      strain sex animal_id lifespan_days censor status
449 C57BL/6J   f        24           333      1      0
450 C57BL/6J   f        25           475      1      0
451 C57BL/6J   f        26           391      1      0
452 C57BL/6J   f       204           272      0      1
453 C57BL/6J   f       205          1049      0      1
454 C57BL/6J   f       206           795      0      1
</code></pre></div></div>

<p>¬†</p>

<p>One way to approach this data would be to just use our pilot inbred lifespan data under the assumption that it can represent the ‚Äútrue‚Äù population. In this scenario we would just randomly draw a sample directly from the C57BL/6J lifespan data using the <code class="language-plaintext highlighter-rouge">sample()</code> function:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># draw a lifespan sample of size 10 from our B6 data frame</span><span class="w">
</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">surv.b6</span><span class="o">$</span><span class="n">lifespan_days</span><span class="p">,</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="n">x</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code> [1]  999 1020  761  727  475 1180  929  539  706  272
</code></pre></div></div>

<p>¬†</p>

<p>While this does produce a sample, our pilot data only represents 64 individuals out of all potential C57BL/6J mice for a phenotype that is highly variable. A better approach, when possible, is to find a distribution that can accurately represent your data. This approach allows for true random sampling with the the confines of the assumption that the real data follows the selected distribution. There are some distributions that can do a decent job at approximating lifespan data. The most common are the Gompertz and Weibull distributions.</p>

<p>¬†</p>
<h4 id="gompertz-and-weibull-distributions-for-lifespan-data">Gompertz and Weibull distributions for lifespan data</h4>

<p>As discussed in our previous class on survival analysis, samples taken from the population-level survival function, \(S(t)\), cannot be considered independent, because each point depends on the value of previous observations. In contrast, each point in the hazard function, \(\lambda(t)\), (aka age-specific mortality, \(\mu_x\)) does not depend on previous values and can be modeled, allowing for independent sampling of a parameter that can be converted to lifespan. The Gompertz and Weibull functions make the assumption that the hazard function takes on a specific (and slightly different) form:</p>

<p><img src="../fig/gompertz-weibull.png" alt="Gompertz and Weibull assumptions" /></p>

<p>¬†</p>

<p>More information and the R functions for dealing with a Gompertz distribution are available in the <code class="language-plaintext highlighter-rouge">flexsurv</code> package. For our purposes, and within the <code class="language-plaintext highlighter-rouge">survival</code> package, we will primarily deal with the Weibull distribution. In the above equations, \(\gamma\) is called the <em>shape</em> and \(\lambda\) is called the scale. For shape, the following relationships hold:</p>
<ul>
  <li>
    <p><strong>\(\gamma &lt; 1\)</strong> indicates that the failure rate (aka mortality) is decreasing over time, such as infant mortality rates.</p>
  </li>
  <li>
    <p><strong>\(\gamma = 1\)</strong> indicates a constant failure rate, such as that for many types of machinery. The Weibull distribution simply collapses to the exponential distributions.</p>
  </li>
  <li>
    <p><strong>\(\gamma &gt; 1\)</strong> indicates an increasing failure rate, which is what we see during aging.</p>
  </li>
</ul>

<p>In contrast, the scale parameter \(\lambda\) simply defines the relative rate at which the hazard is increasing. If we make the assumption that our lifespan data falls within a Weibull distribution, we can use the <code class="language-plaintext highlighter-rouge">survreg()</code> function to identify the shape and scale parameters that best fit our survival data. This uses the same formula notation and definition of our dependent variable with <code class="language-plaintext highlighter-rouge">Surv()</code> that we employed for survival analysis:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># calculate parameters for Weibull distribution</span><span class="w">
</span><span class="n">wei.b6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survreg</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan_days</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surv.b6</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"weibull"</span><span class="p">)</span><span class="w">

</span><span class="c1"># There are multiple ways to parameterize a Weibull distribution. The </span><span class="w">
</span><span class="c1"># survreg() function embeds it in a general location-scale family, which </span><span class="w">
</span><span class="c1"># is a different parameterization than the rweibull function, and often leads</span><span class="w">
</span><span class="c1"># to confusion.</span><span class="w">
</span><span class="c1">#   survreg's scale  =    1/(rweibull shape)</span><span class="w">
</span><span class="c1">#   survreg's intercept = log(rweibull scale)</span><span class="w">

</span><span class="c1"># based on the above, calculate scale and shape for rweibull</span><span class="w">
</span><span class="n">shape.b6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">wei.b6</span><span class="o">$</span><span class="n">scale</span><span class="w">
</span><span class="n">scale.b6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="n">wei.b6</span><span class="o">$</span><span class="n">coefficients</span><span class="p">))</span><span class="w">
</span><span class="n">shape.b6</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 7.116202
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">scale.b6</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] 934.7153
</code></pre></div></div>

<p>¬†</p>

<p>And using these shape and scale parameters, we can now use the <code class="language-plaintext highlighter-rouge">rweibull()</code> function to randomly draw any desired number of samples from the corresponding Weibull distribution.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">samp.b6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6</span><span class="p">,</span><span class="w"> </span><span class="n">scale.b6</span><span class="p">)</span><span class="w">
</span><span class="n">samp.b6</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code> [1]  816.1896  834.3441 1021.2423  798.7520  776.8806 1014.1463  982.2645
 [8]  873.3674  647.2191  769.9492
</code></pre></div></div>

<p>¬†</p>

<p>Note that this is essentially the same operation that we performed to draw a random sample from a defined normal distribution using <code class="language-plaintext highlighter-rouge">rnorm(n, mean, sd)</code>. The parameters are different for <code class="language-plaintext highlighter-rouge">rnorm()</code> (mean and standard deviation) and <code class="language-plaintext highlighter-rouge">rweibull()</code> (shape and scale), but the underlying principle is the same. We are taking a random sample from data with an assumed distribution.</p>

<p>The <em>shape</em> and <em>scale</em> functions define the distribution for our <em>control</em> population. As a first order confirmation, note that the sample generated using <code class="language-plaintext highlighter-rouge">rweibull()</code> have values in the same range as the real lifespan values for C57BL/6J mice in our data set. We will use this sampling procedure to generate samples for both our <em>control</em> population, and for our <em>treatment</em> population under the scenario that \(H_0\) is true.</p>

<p>To generate a distribution for our <em>treatment</em> population under the scenario that \(H_1\) is true, we first have to make another assumption, this time about how the <em>treatment</em> effects the distributions. A useful assumption in this case is that the <em>treatment</em> changes <strong>scale</strong> without affecting  <strong>shape</strong>. Based on the equation for hazard, we can use the <code class="language-plaintext highlighter-rouge">scale</code> parameter to define a desired change in lifespan:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># define change</span><span class="w">
</span><span class="n">change</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.2</span><span class="w"> </span><span class="c1"># 20% change in lifespan</span><span class="w">

</span><span class="c1"># sample a distribution with a 20% increase in scale</span><span class="w">
</span><span class="n">samp.b6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6</span><span class="p">,</span><span class="w"> </span><span class="n">scale.b6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.2</span><span class="o">*</span><span class="n">scale.b6</span><span class="p">)</span><span class="w">
</span><span class="n">samp.b6</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code> [1] 1273.8222 1158.4609 1071.5814  825.2114 1053.4334  747.3514 1048.8987
 [8] 1187.3117 1083.5204 1217.2522
</code></pre></div></div>

<p>¬†</p>

<p>To test the sampling procedure, let‚Äôs draw 10 random samples of 64 mice from both the <em>control</em> population, and a <em>treatment</em> population with a 20% increase in lifespan, and plot the survival curves for each simulated group alongside the survival curves from the original sample from our inbred lifespan study:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># first define the survival curve for the original sample</span><span class="w">
</span><span class="n">survfit.real</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survfit</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan_days</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surv.b6</span><span class="p">)</span><span class="w">

</span><span class="c1"># plot the real survival data</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">survfit.real</span><span class="p">,</span><span class="w"> </span><span class="n">conf.int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">,</span><span class="w"> 
     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"black"</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="c1"># make this line black and thicker</span><span class="w">
     </span><span class="n">xlim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1.5</span><span class="o">*</span><span class="nf">max</span><span class="p">(</span><span class="n">surv.b6</span><span class="o">$</span><span class="n">lifespan_days</span><span class="p">)))</span><span class="w"> </span><span class="c1"># make the x-axis plenty large enough for the next set</span><span class="w">

</span><span class="c1"># run through 10 iterations</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># select a sample of 100 from the estimated "control" and "treatment" Weibull distributions</span><span class="w">
  </span><span class="n">samp.ctrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="m">64</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6</span><span class="p">,</span><span class="w"> </span><span class="n">scale.b6</span><span class="p">)</span><span class="w">
  </span><span class="n">samp.treat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="m">64</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6</span><span class="p">,</span><span class="w"> </span><span class="n">scale.b6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.2</span><span class="o">*</span><span class="n">scale.b6</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># calculate survfit objects (note that we are assuming no censoring here)</span><span class="w">
  </span><span class="n">survfit.ctrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survfit</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">samp.ctrl</span><span class="p">,</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">length</span><span class="p">(</span><span class="n">samp.ctrl</span><span class="p">)))</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
  </span><span class="n">survfit.treat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survfit</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">samp.treat</span><span class="p">,</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="nf">length</span><span class="p">(</span><span class="n">samp.treat</span><span class="p">)))</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
  
  </span><span class="c1"># add lines to the existing plot for current set</span><span class="w">
  </span><span class="n">lines</span><span class="p">(</span><span class="n">survfit.ctrl</span><span class="p">,</span><span class="w"> </span><span class="n">conf.int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">)</span><span class="w">
  </span><span class="n">lines</span><span class="p">(</span><span class="n">survfit.treat</span><span class="p">,</span><span class="w"> </span><span class="n">conf.int</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><img src="../fig/rmd-09-oyo-simulation-unnamed-chunk-7-1.png" title="plot of chunk unnamed-chunk-7" alt="plot of chunk unnamed-chunk-7" width="612" style="display: block; margin: auto;" /></p>

<p>¬†</p>

<p>That looks like a pretty decent approximation of the real data, and gives some idea of what variation to expect, even with a relatively large sample size (64). Now let‚Äôs look at how to use this same procedure to conduct a power analysis.</p>

<hr />
<h3 id="power-analysis-by-simulation">Power analysis by simulation</h3>

<p>For the purposes of this example, we want to know how large we need our sample size to be in order to detect a 20% change at 90% power at a significance level of 0.05 using a log-rank test. As noted above, this style of power analysis always takes in a value for effect size, sample size, and significance level and generates power as an output. What we need to do is run a simulated experiment with a range of sample sizes and figure out which generates a sufficiently high simulated power. Here is how we go about it:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># set power parameters</span><span class="w">
</span><span class="n">alpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.05</span><span class="w">
</span><span class="n">change</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.2</span><span class="w">

</span><span class="c1"># set range of sample sizes</span><span class="w">
</span><span class="n">n.vec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w">

</span><span class="c1"># initialize data frame to store power and alpha values for each sample size</span><span class="w">
</span><span class="n">outcome</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n.vec</span><span class="p">,</span><span class="w"> 
                      </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="kc">NA</span><span class="p">),</span><span class="w">
                      </span><span class="n">power</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="kc">NA</span><span class="p">))</span><span class="w">

</span><span class="c1"># set number of simulated samples</span><span class="w">
</span><span class="n">n.samp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1000</span><span class="w">

</span><span class="c1"># calculate parameters for Weibull distribution</span><span class="w">
</span><span class="n">wei.b6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survreg</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan_days</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surv.b6</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"weibull"</span><span class="p">)</span><span class="w">
</span><span class="n">shape.b6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">wei.b6</span><span class="o">$</span><span class="n">scale</span><span class="w">
</span><span class="n">scale.b6</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="n">wei.b6</span><span class="o">$</span><span class="n">coefficients</span><span class="p">))</span><span class="w">

</span><span class="c1"># start by cycling through sample sizes</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i.n</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">n.vec</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># grab current sample size</span><span class="w">
  </span><span class="n">n.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">n.vec</span><span class="p">[</span><span class="n">i.n</span><span class="p">]</span><span class="w">

  </span><span class="c1"># initialize matrix to record whether null hypothesis was accepted or rejected</span><span class="w">
  </span><span class="n">outcome.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n.samp</span><span class="p">,</span><span class="w"> </span><span class="n">H0.True</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="kc">NA</span><span class="p">),</span><span class="w"> </span><span class="n">H1.True</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="kc">NA</span><span class="p">))</span><span class="w">
  
  </span><span class="c1"># start sampling procedure -- for each iteration, do the following:</span><span class="w">
  </span><span class="c1">#  1. generate test sample from each distribution (control, </span><span class="w">
  </span><span class="c1">#     control (H0 true) and simulated 20% extension (H1 true))</span><span class="w">
  </span><span class="c1">#  2. run a log rank test to determine what we would conclude given</span><span class="w">
  </span><span class="c1">#     the current sample</span><span class="w">
  </span><span class="c1">#  3. record outcome for both comparisons to the outcome matrix</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i.samp</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n.samp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1"># print every 100 samples</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">i.samp</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="m">250</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Now starting sample"</span><span class="p">,</span><span class="n">i.samp</span><span class="p">,</span><span class="w"> </span><span class="s2">"for sample size"</span><span class="p">,</span><span class="n">n.c</span><span class="p">))</span><span class="w">
    </span><span class="p">}</span><span class="w">
    
    </span><span class="c1"># generate control sample and embed in test data frame</span><span class="w">
    </span><span class="n">samp.ctrl.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="n">n.c</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6</span><span class="p">,</span><span class="w"> </span><span class="n">scale.b6</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.ctrl.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lifespan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samp.ctrl.c</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"control"</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># generate test sample assuming H0 is true</span><span class="w">
    </span><span class="n">samp.test.H0true.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="n">n.c</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6</span><span class="p">,</span><span class="w"> </span><span class="n">scale.b6</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.test.H0true.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lifespan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samp.test.H0true.c</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># generate test sample assuming H1 is true</span><span class="w">
    </span><span class="n">samp.test.H1true.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="n">n.c</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6</span><span class="p">,</span><span class="w"> </span><span class="n">scale.b6</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">change</span><span class="o">*</span><span class="n">scale.b6</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.test.H1true.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lifespan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samp.test.H1true.c</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># setup data frames for H0 and H1 true for testing</span><span class="w">
    </span><span class="n">surv.H0true.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">surv.ctrl.c</span><span class="p">,</span><span class="w"> </span><span class="n">surv.test.H0true.c</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.H1true.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">surv.ctrl.c</span><span class="p">,</span><span class="w"> </span><span class="n">surv.test.H1true.c</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># run log-rank test</span><span class="w">
    </span><span class="n">logrank.H0true</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surv.H0true.c</span><span class="p">)</span><span class="w">
    </span><span class="n">logrank.H1true</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surv.H1true.c</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># calculate P-values from logrank chisq statistics</span><span class="w">
    </span><span class="n">p.H0true</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pchisq</span><span class="p">(</span><span class="n">logrank.H0true</span><span class="o">$</span><span class="n">chisq</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">logrank.H0true</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lower.tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
    </span><span class="n">p.H1true</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pchisq</span><span class="p">(</span><span class="n">logrank.H1true</span><span class="o">$</span><span class="n">chisq</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">logrank.H1true</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lower.tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># record outcome (1 = accept H0, 0 = reject H0)</span><span class="w">
    </span><span class="n">outcome.c</span><span class="o">$</span><span class="n">H0.True</span><span class="p">[</span><span class="n">i.samp</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">p.H0true</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w">
    </span><span class="n">outcome.c</span><span class="o">$</span><span class="n">H1.True</span><span class="p">[</span><span class="n">i.samp</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">p.H1true</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="c1"># Build hypothesis table</span><span class="w">
  </span><span class="n">h.table.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">outcome</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Accept H0"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Reject H0"</span><span class="p">),</span><span class="w"> 
                         </span><span class="n">H0.true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.c</span><span class="o">$</span><span class="n">H0.True</span><span class="p">),</span><span class="w"> </span><span class="n">n.samp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.c</span><span class="o">$</span><span class="n">H0.True</span><span class="p">)),</span><span class="w">
                         </span><span class="n">H1.true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.c</span><span class="o">$</span><span class="n">H1.True</span><span class="p">),</span><span class="w"> </span><span class="n">n.samp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.c</span><span class="o">$</span><span class="n">H1.True</span><span class="p">)))</span><span class="w">
  
  </span><span class="c1"># update power and significance data frames</span><span class="w">
  </span><span class="n">outcome</span><span class="o">$</span><span class="n">alpha</span><span class="p">[</span><span class="n">i.n</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">h.table.c</span><span class="o">$</span><span class="n">H0.true</span><span class="p">[</span><span class="n">h.table.c</span><span class="o">$</span><span class="n">outcome</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Reject H0"</span><span class="p">]</span><span class="o">/</span><span class="n">n.samp</span><span class="w">
  </span><span class="n">outcome</span><span class="o">$</span><span class="n">power</span><span class="p">[</span><span class="n">i.n</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">h.table.c</span><span class="o">$</span><span class="n">H1.true</span><span class="p">[</span><span class="n">h.table.c</span><span class="o">$</span><span class="n">outcome</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Reject H0"</span><span class="p">]</span><span class="o">/</span><span class="n">n.samp</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "Now starting sample 250 for sample size 5"
[1] "Now starting sample 500 for sample size 5"
[1] "Now starting sample 750 for sample size 5"
[1] "Now starting sample 1000 for sample size 5"
[1] "Now starting sample 250 for sample size 10"
[1] "Now starting sample 500 for sample size 10"
[1] "Now starting sample 750 for sample size 10"
[1] "Now starting sample 1000 for sample size 10"
[1] "Now starting sample 250 for sample size 15"
[1] "Now starting sample 500 for sample size 15"
[1] "Now starting sample 750 for sample size 15"
[1] "Now starting sample 1000 for sample size 15"
[1] "Now starting sample 250 for sample size 20"
[1] "Now starting sample 500 for sample size 20"
[1] "Now starting sample 750 for sample size 20"
[1] "Now starting sample 1000 for sample size 20"
[1] "Now starting sample 250 for sample size 25"
[1] "Now starting sample 500 for sample size 25"
[1] "Now starting sample 750 for sample size 25"
[1] "Now starting sample 1000 for sample size 25"
[1] "Now starting sample 250 for sample size 30"
[1] "Now starting sample 500 for sample size 30"
[1] "Now starting sample 750 for sample size 30"
[1] "Now starting sample 1000 for sample size 30"
[1] "Now starting sample 250 for sample size 35"
[1] "Now starting sample 500 for sample size 35"
[1] "Now starting sample 750 for sample size 35"
[1] "Now starting sample 1000 for sample size 35"
[1] "Now starting sample 250 for sample size 40"
[1] "Now starting sample 500 for sample size 40"
[1] "Now starting sample 750 for sample size 40"
[1] "Now starting sample 1000 for sample size 40"
[1] "Now starting sample 250 for sample size 45"
[1] "Now starting sample 500 for sample size 45"
[1] "Now starting sample 750 for sample size 45"
[1] "Now starting sample 1000 for sample size 45"
[1] "Now starting sample 250 for sample size 50"
[1] "Now starting sample 500 for sample size 50"
[1] "Now starting sample 750 for sample size 50"
[1] "Now starting sample 1000 for sample size 50"
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># show outcome</span><span class="w">
</span><span class="n">outcome</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    N alpha power
1   5 0.080 0.424
2  10 0.075 0.751
3  15 0.062 0.903
4  20 0.066 0.970
5  25 0.067 0.991
6  30 0.064 0.997
7  35 0.060 1.000
8  40 0.062 0.999
9  45 0.051 1.000
10 50 0.061 1.000
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Check out the distribution of calculated alphas</span><span class="w">
</span><span class="n">hist</span><span class="p">(</span><span class="n">outcome</span><span class="o">$</span><span class="n">alpha</span><span class="p">,</span><span class="w"> </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">15</span><span class="p">,</span><span class="w"> </span><span class="n">freq</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../fig/rmd-09-oyo-simulation-unnamed-chunk-8-1.png" title="plot of chunk unnamed-chunk-8" alt="plot of chunk unnamed-chunk-8" width="612" style="display: block; margin: auto;" /></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># generate power plot to compare power vs. sample size</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">outcome</span><span class="o">$</span><span class="n">power</span><span class="p">,</span><span class="w"> </span><span class="n">outcome</span><span class="o">$</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">,</span><span class="w"> 
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="s2">"Power analysis for 20% change in\nC57BL/6J lifespan (alpha = 0.05)"</span><span class="p">,</span><span class="w">
     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Sample Size"</span><span class="p">,</span><span class="w"> 
     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Power"</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="../fig/rmd-09-oyo-simulation-unnamed-chunk-8-2.png" title="plot of chunk unnamed-chunk-8" alt="plot of chunk unnamed-chunk-8" width="612" style="display: block; margin: auto;" /></p>

<p>¬†</p>

<p>It looks like we need somewhere around 16 mice to have 90% power to detect a 20% change in C57BL/6J lifespan at \(\alpha = 0.05\).</p>

<p>Note that the precision of the power and significance calculated based on the simulation is strictly determined by the number of times we run the simulated experiment. If we only run 100 iterations, we will only be able to distinguish a significance level or power differences down to 1/100 = 0.01.</p>

<blockquote class="challenge">
  <h2 id="revisiting-the-impact-of-sex-on-power">Revisiting the impact of sex on power</h2>

  <p><em>In Class</em> we found that the higher variability in female 
lifespan substantially increased the number of mice required to 
detect a given given lifespan extension in C57BL/6J mice. Let‚Äôs 
revisit this question using our simulated lifespand data.</p>

  <p>Generate power vs. sample size charts for the ability to detect 
a 15% change in lifespan at a significance level of 0.05 in male 
and female C57BL/6J mice.</p>

  <blockquote class="solution">
    <h2 id="solution">Solution</h2>

    <p>Make sure we have the <code class="language-plaintext highlighter-rouge">survival</code> package and inbred mouse 
lifespan data loaded. Subset the data for C57BL/6J females and 
males separately.</p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># load library</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="s2">"survival"</span><span class="p">)</span><span class="w">

</span><span class="c1"># load inbred mouse lifespan data</span><span class="w">
</span><span class="n">data.surv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.delim</span><span class="p">(</span><span class="s2">"data/inbred.lifespan.txt"</span><span class="p">)</span><span class="w">

</span><span class="c1"># define status variable to indicate "death" events</span><span class="w">
</span><span class="n">data.surv</span><span class="o">$</span><span class="n">status</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="o">!</span><span class="n">data.surv</span><span class="o">$</span><span class="n">censor</span><span class="p">)</span><span class="w">

</span><span class="c1"># Grab C57BL/6J data subset</span><span class="w">
</span><span class="n">b6.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.surv</span><span class="p">[</span><span class="n">data.surv</span><span class="o">$</span><span class="n">strain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"C57BL/6J"</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> 
</span><span class="n">data.surv</span><span class="o">$</span><span class="n">sex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"f"</span><span class="p">,]</span><span class="w">
</span><span class="n">b6.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.surv</span><span class="p">[</span><span class="n">data.surv</span><span class="o">$</span><span class="n">strain</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"C57BL/6J"</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> 
</span><span class="n">data.surv</span><span class="o">$</span><span class="n">sex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"m"</span><span class="p">,]</span><span class="w">
</span></code></pre></div>    </div>

    <p>¬†</p>

    <p>Now set up our variables and run our simulation for both 
sexes. We can do this all in the same loop. Since there are 
only two sexes, I opted not to build a second for loop to 
cycle through the two options for sex (though that is an 
alternative, and would have saved me some lines of code).</p>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># set power parameters</span><span class="w">
</span><span class="n">alpha</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.05</span><span class="w">
</span><span class="n">change</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.15</span><span class="w">

</span><span class="c1"># set range of sample sizes</span><span class="w">
</span><span class="n">n.vec</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="m">5</span><span class="p">)</span><span class="w">

</span><span class="c1"># initialize data frames to store power and alpha values </span><span class="w">
</span><span class="c1"># for each sample size. We will just do one for each sex</span><span class="w">
</span><span class="n">outcome.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n.vec</span><span class="p">,</span><span class="w"> 
                      </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="kc">NA</span><span class="p">),</span><span class="w">
                      </span><span class="n">power</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="kc">NA</span><span class="p">))</span><span class="w">
</span><span class="n">outcome.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n.vec</span><span class="p">,</span><span class="w"> 
                      </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="kc">NA</span><span class="p">),</span><span class="w">
                      </span><span class="n">power</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="kc">NA</span><span class="p">))</span><span class="w">

</span><span class="c1"># set number of simulated samples</span><span class="w">
</span><span class="n">n.samp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1000</span><span class="w">

</span><span class="c1"># calculate parameters for Weibull distribution</span><span class="w">
</span><span class="n">wei.b6.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survreg</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan_days</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b6.f</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"weibull"</span><span class="p">)</span><span class="w">
</span><span class="n">shape.b6.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">wei.b6.f</span><span class="o">$</span><span class="n">scale</span><span class="w">
</span><span class="n">scale.b6.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="n">wei.b6.f</span><span class="o">$</span><span class="n">coefficients</span><span class="p">))</span><span class="w">

</span><span class="n">wei.b6.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survreg</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan_days</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b6.m</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"weibull"</span><span class="p">)</span><span class="w">
</span><span class="n">shape.b6.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="o">/</span><span class="n">wei.b6.m</span><span class="o">$</span><span class="n">scale</span><span class="w">
</span><span class="n">scale.b6.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">exp</span><span class="p">(</span><span class="n">wei.b6.m</span><span class="o">$</span><span class="n">coefficients</span><span class="p">))</span><span class="w">

</span><span class="c1"># start by cycling through sample sizes</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i.n</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">n.vec</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># grab current sample size</span><span class="w">
  </span><span class="n">n.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">n.vec</span><span class="p">[</span><span class="n">i.n</span><span class="p">]</span><span class="w">

  </span><span class="c1"># initialize matrices to record whether null hypothesis     </span><span class="w">
  </span><span class="c1"># was accepted or rejected</span><span class="w">
  </span><span class="n">outcome.f.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n.samp</span><span class="p">,</span><span class="w"> 
                            </span><span class="n">H0.True</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="kc">NA</span><span class="p">),</span><span class="w"> 
                            </span><span class="n">H1.True</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="kc">NA</span><span class="p">))</span><span class="w">
   </span><span class="n">outcome.m.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">Sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n.samp</span><span class="p">,</span><span class="w"> 
                             </span><span class="n">H0.True</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="kc">NA</span><span class="p">),</span><span class="w"> 
                             </span><span class="n">H1.True</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="kc">NA</span><span class="p">))</span><span class="w">
  
  </span><span class="c1"># start sampling procedure -- for each iteration, do the   </span><span class="w">
  </span><span class="c1"># following:</span><span class="w">
  </span><span class="c1">#  1. generate test sample from each distribution (control, </span><span class="w">
  </span><span class="c1">#     control (H0 true) and simulated 20% extension </span><span class="w">
  </span><span class="c1">#     (H1 true))</span><span class="w">
  </span><span class="c1">#  2. run a log rank test to determine what we would  </span><span class="w">
  </span><span class="c1">#     conclude given the current sample</span><span class="w">
  </span><span class="c1">#  3. record outcome for both comparisons to the outcome </span><span class="w">
  </span><span class="c1">#     matrix</span><span class="w">
  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i.samp</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n.samp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="c1"># print every 100 samples</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">i.samp</span><span class="w"> </span><span class="o">%%</span><span class="w"> </span><span class="m">250</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Now starting sample"</span><span class="p">,</span><span class="n">i.samp</span><span class="p">,</span><span class="w"> </span><span class="s2">"for sample size"</span><span class="p">,</span><span class="n">n.c</span><span class="p">))</span><span class="w">
    </span><span class="p">}</span><span class="w">
    
    </span><span class="c1"># generate control sample and embed in test data frame</span><span class="w">
    </span><span class="n">samp.ctrl.f.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="n">n.c</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6.f</span><span class="p">,</span><span class="w"> </span><span class="n">scale.b6.f</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.ctrl.f.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lifespan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samp.ctrl.f.c</span><span class="p">,</span><span class="w"> 
                                </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"control"</span><span class="p">,</span><span class="w"> 
                                </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
    
    </span><span class="n">samp.ctrl.m.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="n">n.c</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6.m</span><span class="p">,</span><span class="w"> </span><span class="n">scale.b6.f</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.ctrl.m.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lifespan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samp.ctrl.m.c</span><span class="p">,</span><span class="w"> 
                                </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"control"</span><span class="p">,</span><span class="w"> 
                                </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># generate test sample assuming H0 is true</span><span class="w">
    </span><span class="n">samp.test.H0true.f.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="n">n.c</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6.f</span><span class="p">,</span><span class="w"> 
                                     </span><span class="n">scale.b6.f</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.test.H0true.f.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lifespan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samp.test.H0true.f.c</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
    
    </span><span class="n">samp.test.H0true.m.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="n">n.c</span><span class="p">,</span><span class="w"> 
                                     </span><span class="n">shape.b6.m</span><span class="p">,</span><span class="w"> 
                                     </span><span class="n">scale.b6.m</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.test.H0true.m.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lifespan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samp.test.H0true.m.c</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># generate test sample assuming H1 is true</span><span class="w">
    </span><span class="n">samp.test.H1true.f.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="n">n.c</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6.f</span><span class="p">,</span><span class="w"> 
                            </span><span class="n">scale.b6.f</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">change</span><span class="o">*</span><span class="n">scale.b6.f</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.test.H1true.f.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lifespan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samp.test.H1true.f.c</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
    
     </span><span class="n">samp.test.H1true.m.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rweibull</span><span class="p">(</span><span class="n">n.c</span><span class="p">,</span><span class="w"> </span><span class="n">shape.b6.m</span><span class="p">,</span><span class="w"> </span><span class="n">scale.b6.m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">change</span><span class="o">*</span><span class="n">scale.b6.m</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.test.H1true.m.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">lifespan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">samp.test.H1true.m.c</span><span class="p">,</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"test"</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># setup data frames for H0 and H1 true for testing</span><span class="w">
    </span><span class="n">surv.H0true.f.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">surv.ctrl.f.c</span><span class="p">,</span><span class="w"> </span><span class="n">surv.test.H0true.f.c</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.H1true.f.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">surv.ctrl.f.c</span><span class="p">,</span><span class="w"> </span><span class="n">surv.test.H1true.f.c</span><span class="p">)</span><span class="w">
    
    </span><span class="n">surv.H0true.m.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">surv.ctrl.m.c</span><span class="p">,</span><span class="w"> </span><span class="n">surv.test.H0true.m.c</span><span class="p">)</span><span class="w">
    </span><span class="n">surv.H1true.m.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rbind</span><span class="p">(</span><span class="n">surv.ctrl.m.c</span><span class="p">,</span><span class="w"> </span><span class="n">surv.test.H1true.m.c</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># run log-rank test</span><span class="w">
    </span><span class="n">logrank.H0true.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surv.H0true.f.c</span><span class="p">)</span><span class="w">
    </span><span class="n">logrank.H1true.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surv.H1true.f.c</span><span class="p">)</span><span class="w">
    
    </span><span class="n">logrank.H0true.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surv.H0true.m.c</span><span class="p">)</span><span class="w">
    </span><span class="n">logrank.H1true.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">survdiff</span><span class="p">(</span><span class="n">Surv</span><span class="p">(</span><span class="n">lifespan</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">group</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">surv.H1true.m.c</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># calculate P-values from logrank chisq statistics</span><span class="w">
    </span><span class="n">p.H0true.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pchisq</span><span class="p">(</span><span class="n">logrank.H0true.f</span><span class="o">$</span><span class="n">chisq</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">logrank.H0true.f</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lower.tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
    </span><span class="n">p.H1true.f</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pchisq</span><span class="p">(</span><span class="n">logrank.H1true.f</span><span class="o">$</span><span class="n">chisq</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">logrank.H1true.f</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lower.tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
    
    </span><span class="n">p.H0true.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pchisq</span><span class="p">(</span><span class="n">logrank.H0true.m</span><span class="o">$</span><span class="n">chisq</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">logrank.H0true.m</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lower.tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
    </span><span class="n">p.H1true.m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">pchisq</span><span class="p">(</span><span class="n">logrank.H1true.m</span><span class="o">$</span><span class="n">chisq</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">logrank.H1true.m</span><span class="o">$</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">lower.tail</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">)</span><span class="w">
    
    </span><span class="c1"># record outcome (1 = accept H0, 0 = reject H0)</span><span class="w">
    </span><span class="n">outcome.f.c</span><span class="o">$</span><span class="n">H0.True</span><span class="p">[</span><span class="n">i.samp</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">p.H0true.f</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w">
    </span><span class="n">outcome.f.c</span><span class="o">$</span><span class="n">H1.True</span><span class="p">[</span><span class="n">i.samp</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">p.H1true.f</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w">
    
    </span><span class="n">outcome.m.c</span><span class="o">$</span><span class="n">H0.True</span><span class="p">[</span><span class="n">i.samp</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">p.H0true.m</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w">
    </span><span class="n">outcome.m.c</span><span class="o">$</span><span class="n">H1.True</span><span class="p">[</span><span class="n">i.samp</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.integer</span><span class="p">(</span><span class="n">p.H1true.m</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m">0.05</span><span class="p">)</span><span class="w">
  </span><span class="p">}</span><span class="w">
  
  </span><span class="c1"># Build hypothesis table</span><span class="w">
  </span><span class="n">h.table.f.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">outcome</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Accept H0"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Reject H0"</span><span class="p">),</span><span class="w"> 
                         </span><span class="n">H0.true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.f.c</span><span class="o">$</span><span class="n">H0.True</span><span class="p">),</span><span class="w"> 
</span><span class="n">n.samp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.f.c</span><span class="o">$</span><span class="n">H0.True</span><span class="p">)),</span><span class="w">
                         </span><span class="n">H1.true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.f.c</span><span class="o">$</span><span class="n">H1.True</span><span class="p">),</span><span class="w"> 
</span><span class="n">n.samp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.f.c</span><span class="o">$</span><span class="n">H1.True</span><span class="p">)))</span><span class="w">
  
    </span><span class="n">h.table.m.c</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">outcome</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"Accept H0"</span><span class="p">,</span><span class="w"> </span><span class="s2">"Reject H0"</span><span class="p">),</span><span class="w"> 
                         </span><span class="n">H0.true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.m.c</span><span class="o">$</span><span class="n">H0.True</span><span class="p">),</span><span class="w"> 
</span><span class="n">n.samp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.m.c</span><span class="o">$</span><span class="n">H0.True</span><span class="p">)),</span><span class="w">
                         </span><span class="n">H1.true</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.m.c</span><span class="o">$</span><span class="n">H1.True</span><span class="p">),</span><span class="w"> 
</span><span class="n">n.samp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">sum</span><span class="p">(</span><span class="n">outcome.m.c</span><span class="o">$</span><span class="n">H1.True</span><span class="p">)))</span><span class="w">
  
  </span><span class="c1"># update power and significance data frames</span><span class="w">
  </span><span class="n">outcome.f</span><span class="o">$</span><span class="n">alpha</span><span class="p">[</span><span class="n">i.n</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">h.table.f.c</span><span class="o">$</span><span class="n">H0.true</span><span class="p">[</span><span class="n">h.table.f.c</span><span class="o">$</span><span class="n">outcome</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Reject H0"</span><span class="p">]</span><span class="o">/</span><span class="n">n.samp</span><span class="w">
  </span><span class="n">outcome.f</span><span class="o">$</span><span class="n">power</span><span class="p">[</span><span class="n">i.n</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">h.table.f.c</span><span class="o">$</span><span class="n">H1.true</span><span class="p">[</span><span class="n">h.table.f.c</span><span class="o">$</span><span class="n">outcome</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Reject H0"</span><span class="p">]</span><span class="o">/</span><span class="n">n.samp</span><span class="w">
  
    </span><span class="n">outcome.m</span><span class="o">$</span><span class="n">alpha</span><span class="p">[</span><span class="n">i.n</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">h.table.m.c</span><span class="o">$</span><span class="n">H0.true</span><span class="p">[</span><span class="n">h.table.m.c</span><span class="o">$</span><span class="n">outcome</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Reject H0"</span><span class="p">]</span><span class="o">/</span><span class="n">n.samp</span><span class="w">
  </span><span class="n">outcome.m</span><span class="o">$</span><span class="n">power</span><span class="p">[</span><span class="n">i.n</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">h.table.m.c</span><span class="o">$</span><span class="n">H1.true</span><span class="p">[</span><span class="n">h.table.f.c</span><span class="o">$</span><span class="n">outcome</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"Reject H0"</span><span class="p">]</span><span class="o">/</span><span class="n">n.samp</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[1] "Now starting sample 250 for sample size 5"
[1] "Now starting sample 500 for sample size 5"
[1] "Now starting sample 750 for sample size 5"
[1] "Now starting sample 1000 for sample size 5"
[1] "Now starting sample 250 for sample size 10"
[1] "Now starting sample 500 for sample size 10"
[1] "Now starting sample 750 for sample size 10"
[1] "Now starting sample 1000 for sample size 10"
[1] "Now starting sample 250 for sample size 15"
[1] "Now starting sample 500 for sample size 15"
[1] "Now starting sample 750 for sample size 15"
[1] "Now starting sample 1000 for sample size 15"
[1] "Now starting sample 250 for sample size 20"
[1] "Now starting sample 500 for sample size 20"
[1] "Now starting sample 750 for sample size 20"
[1] "Now starting sample 1000 for sample size 20"
[1] "Now starting sample 250 for sample size 25"
[1] "Now starting sample 500 for sample size 25"
[1] "Now starting sample 750 for sample size 25"
[1] "Now starting sample 1000 for sample size 25"
[1] "Now starting sample 250 for sample size 30"
[1] "Now starting sample 500 for sample size 30"
[1] "Now starting sample 750 for sample size 30"
[1] "Now starting sample 1000 for sample size 30"
[1] "Now starting sample 250 for sample size 35"
[1] "Now starting sample 500 for sample size 35"
[1] "Now starting sample 750 for sample size 35"
[1] "Now starting sample 1000 for sample size 35"
[1] "Now starting sample 250 for sample size 40"
[1] "Now starting sample 500 for sample size 40"
[1] "Now starting sample 750 for sample size 40"
[1] "Now starting sample 1000 for sample size 40"
[1] "Now starting sample 250 for sample size 45"
[1] "Now starting sample 500 for sample size 45"
[1] "Now starting sample 750 for sample size 45"
[1] "Now starting sample 1000 for sample size 45"
[1] "Now starting sample 250 for sample size 50"
[1] "Now starting sample 500 for sample size 50"
[1] "Now starting sample 750 for sample size 50"
[1] "Now starting sample 1000 for sample size 50"
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># show outcome</span><span class="w">
</span><span class="n">outcome.f</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    N alpha power
1   5 0.065 0.197
2  10 0.068 0.415
3  15 0.065 0.577
4  20 0.043 0.705
5  25 0.053 0.806
6  30 0.062 0.882
7  35 0.056 0.898
8  40 0.051 0.945
9  45 0.046 0.959
10 50 0.052 0.987
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">outcome.m</span><span class="w">
</span></code></pre></div>    </div>

    <div class="language-plaintext output highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    N alpha power
1   5 0.096 0.494
2  10 0.105 0.794
3  15 0.097 0.947
4  20 0.100 0.986
5  25 0.125 0.996
6  30 0.105 1.000
7  35 0.119 1.000
8  40 0.135 1.000
9  45 0.146 1.000
10 50 0.157 1.000
</code></pre></div>    </div>

    <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># generate power plot to compare power vs. sample size</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">outcome.f</span><span class="o">$</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">outcome.f</span><span class="o">$</span><span class="n">power</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"l"</span><span class="p">,</span><span class="w"> 
     </span><span class="n">main</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="s2">"Power analysis for 20% change in\nC57BL/6J lifespan (alpha = 0.05)"</span><span class="p">,</span><span class="w">
     </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Sample Size"</span><span class="p">,</span><span class="w"> 
     </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Power"</span><span class="p">,</span><span class="w">
     </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">)</span><span class="w">
</span><span class="n">lines</span><span class="p">(</span><span class="n">outcome.m</span><span class="o">$</span><span class="n">N</span><span class="p">,</span><span class="w"> </span><span class="n">outcome.m</span><span class="o">$</span><span class="n">power</span><span class="p">,</span><span class="w">  </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"blue"</span><span class="p">)</span><span class="w">
</span></code></pre></div>    </div>

    <p><img src="../fig/rmd-09-oyo-simulation-unnamed-chunk-10-1.png" title="plot of chunk unnamed-chunk-10" alt="plot of chunk unnamed-chunk-10" width="612" style="display: block; margin: auto;" /></p>

    <p>¬†</p>

    <p>As expected from our t-test example, we need a fair number of 
extra female mice to achieve an equivalent power level to 
males in the C56BL/6J strain background. In this case, the 
distribution that we selected more closely matches the actual 
shape of the data, so we can be more confident in these values 
relative to those calculated with the t-test.</p>
  </blockquote>
</blockquote>

<hr />

:ET